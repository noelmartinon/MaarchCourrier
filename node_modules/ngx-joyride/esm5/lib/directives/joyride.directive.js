import { __decorate, __param } from "tslib";
import { Directive, ElementRef, AfterViewInit, Input, ViewContainerRef, TemplateRef, Output, EventEmitter, Inject, PLATFORM_ID, OnChanges, SimpleChanges, OnDestroy } from '@angular/core';
import { JoyrideStep } from '../models/joyride-step.class';
import { JoyrideStepsContainerService } from '../services/joyride-steps-container.service';
import { JoyrideError } from '../models/joyride-error.class';
import { Router } from '@angular/router';
import { DomRefService } from '../services/dom.service';
import { isPlatformBrowser } from '@angular/common';
import { TemplatesService } from '../services/templates.service';
import { Observable } from 'rxjs';
export var NO_POSITION = 'NO_POSITION';
var JoyrideDirective = /** @class */ (function () {
    function JoyrideDirective(joyrideStepsContainer, viewContainerRef, domService, router, templateService, platformId) {
        this.joyrideStepsContainer = joyrideStepsContainer;
        this.viewContainerRef = viewContainerRef;
        this.domService = domService;
        this.router = router;
        this.templateService = templateService;
        this.platformId = platformId;
        this.stepPosition = NO_POSITION;
        this.prev = new EventEmitter();
        this.next = new EventEmitter();
        this.done = new EventEmitter();
        this.subscriptions = [];
        this.windowRef = this.domService.getNativeWindow();
        this.step = new JoyrideStep();
    }
    JoyrideDirective.prototype.ngAfterViewInit = function () {
        if (!isPlatformBrowser(this.platformId))
            return;
        if (this.prevTemplate)
            this.templateService.setPrevButton(this.prevTemplate);
        if (this.nextTemplate)
            this.templateService.setNextButton(this.nextTemplate);
        if (this.doneTemplate)
            this.templateService.setDoneButton(this.doneTemplate);
        if (this.counterTemplate)
            this.templateService.setCounter(this.counterTemplate);
        this.step.position = this.stepPosition;
        this.step.targetViewContainer = this.viewContainerRef;
        this.setAsyncFields(this.step);
        this.step.stepContent = this.stepContent;
        this.step.stepContentParams = this.stepContentParams;
        this.step.nextClicked = this.next;
        this.step.prevCliked = this.prev;
        this.step.tourDone = this.done;
        if (!this.name)
            throw new JoyrideError("All the steps should have the 'joyrideStep' property set with a custom name.");
        this.step.name = this.name;
        this.step.route = this.router.url.substr(0, 1) === '/' ? this.router.url.substr(1) : this.router.url;
        this.step.transformCssStyle = this.windowRef.getComputedStyle(this.viewContainerRef.element.nativeElement).transform;
        this.step.isElementOrAncestorFixed =
            this.isElementFixed(this.viewContainerRef.element) ||
                this.isAncestorsFixed(this.viewContainerRef.element.nativeElement.parentElement);
        this.joyrideStepsContainer.addStep(this.step);
    };
    JoyrideDirective.prototype.ngOnChanges = function (changes) {
        if (changes['title'] || changes['text']) {
            this.setAsyncFields(this.step);
        }
    };
    JoyrideDirective.prototype.isElementFixed = function (element) {
        return this.windowRef.getComputedStyle(element.nativeElement).position === 'fixed';
    };
    JoyrideDirective.prototype.setAsyncFields = function (step) {
        if (this.title instanceof Observable) {
            this.subscriptions.push(this.title.subscribe(function (title) {
                step.title.next(title);
            }));
        }
        else {
            step.title.next(this.title);
        }
        if (this.text instanceof Observable) {
            this.subscriptions.push(this.text.subscribe(function (text) {
                step.text.next(text);
            }));
        }
        else {
            step.text.next(this.text);
        }
    };
    JoyrideDirective.prototype.isAncestorsFixed = function (nativeElement) {
        if (!nativeElement || !nativeElement.parentElement)
            return false;
        var isElementFixed = this.windowRef.getComputedStyle(nativeElement.parentElement).position === 'fixed';
        if (nativeElement.nodeName === 'BODY') {
            return isElementFixed;
        }
        if (isElementFixed)
            return true;
        else
            return this.isAncestorsFixed(nativeElement.parentElement);
    };
    JoyrideDirective.prototype.ngOnDestroy = function () {
        this.subscriptions.forEach(function (sub) {
            sub.unsubscribe();
        });
    };
    JoyrideDirective.ctorParameters = function () { return [
        { type: JoyrideStepsContainerService },
        { type: ViewContainerRef },
        { type: DomRefService },
        { type: Router },
        { type: TemplatesService },
        { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
    ]; };
    __decorate([
        Input('joyrideStep')
    ], JoyrideDirective.prototype, "name", void 0);
    __decorate([
        Input()
    ], JoyrideDirective.prototype, "nextStep", void 0);
    __decorate([
        Input()
    ], JoyrideDirective.prototype, "title", void 0);
    __decorate([
        Input()
    ], JoyrideDirective.prototype, "text", void 0);
    __decorate([
        Input()
    ], JoyrideDirective.prototype, "stepPosition", void 0);
    __decorate([
        Input()
    ], JoyrideDirective.prototype, "stepContent", void 0);
    __decorate([
        Input()
    ], JoyrideDirective.prototype, "stepContentParams", void 0);
    __decorate([
        Input()
    ], JoyrideDirective.prototype, "prevTemplate", void 0);
    __decorate([
        Input()
    ], JoyrideDirective.prototype, "nextTemplate", void 0);
    __decorate([
        Input()
    ], JoyrideDirective.prototype, "doneTemplate", void 0);
    __decorate([
        Input()
    ], JoyrideDirective.prototype, "counterTemplate", void 0);
    __decorate([
        Output()
    ], JoyrideDirective.prototype, "prev", void 0);
    __decorate([
        Output()
    ], JoyrideDirective.prototype, "next", void 0);
    __decorate([
        Output()
    ], JoyrideDirective.prototype, "done", void 0);
    JoyrideDirective = __decorate([
        Directive({
            selector: 'joyrideStep, [joyrideStep]'
        }),
        __param(5, Inject(PLATFORM_ID))
    ], JoyrideDirective);
    return JoyrideDirective;
}());
export { JoyrideDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiam95cmlkZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtam95cmlkZS8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2pveXJpZGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0gsU0FBUyxFQUNULFVBQVUsRUFDVixhQUFhLEVBQ2IsS0FBSyxFQUNMLGdCQUFnQixFQUNoQixXQUFXLEVBQ1gsTUFBTSxFQUNOLFlBQVksRUFDWixNQUFNLEVBQ04sV0FBVyxFQUNYLFNBQVMsRUFDVCxhQUFhLEVBQ2IsU0FBUyxFQUNaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSw2Q0FBNkMsQ0FBQztBQUMzRixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDN0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUNqRSxPQUFPLEVBQUUsVUFBVSxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUVoRCxNQUFNLENBQUMsSUFBTSxXQUFXLEdBQUcsYUFBYSxDQUFDO0FBS3pDO0lBK0NJLDBCQUNxQixxQkFBbUQsRUFDNUQsZ0JBQWtDLEVBQ3pCLFVBQXlCLEVBQ3pCLE1BQWMsRUFDZCxlQUFpQyxFQUNyQixVQUFrQjtRQUw5QiwwQkFBcUIsR0FBckIscUJBQXFCLENBQThCO1FBQzVELHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDekIsZUFBVSxHQUFWLFVBQVUsQ0FBZTtRQUN6QixXQUFNLEdBQU4sTUFBTSxD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QURDLEtBQUssRUFBRTswREFDd0I7SUFHaEM7UUFEQyxLQUFLLEVBQUU7MERBQ3dCO0lBR2hDO1FBREMsS0FBSyxFQUFFOzBEQUN3QjtJQUdoQztRQURDLEtBQUssRUFBRTs2REFDMkI7SUFHbkM7UUFEQyxNQUFNLEVBQUU7a0RBQzBDO0lBR25EO1FBREMsTUFBTSxFQUFFO2tEQUMwQztJQUduRDtRQURDLE1BQU0sRUFBRTtrREFDMEM7SUF6QzFDLGdCQUFnQjtRQUg1QixTQUFTLENBQUM7WUFDUCxRQUFRLEVBQUUsNEJBQTRCO1NBQ3pDLENBQUM7UUFzRE8sV0FBQSxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUE7T0FyRGYsZ0JBQWdCLENBa0k1QjtJQUFELHVCQUFDO0NBQUEsQUFsSUQsSUFrSUM7U0FsSVksZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBEaXJlY3RpdmUsXG4gICAgRWxlbWVudFJlZixcbiAgICBBZnRlclZpZXdJbml0LFxuICAgIElucHV0LFxuICAgIFZpZXdDb250YWluZXJSZWYsXG4gICAgVGVtcGxhdGVSZWYsXG4gICAgT3V0cHV0LFxuICAgIEV2ZW50RW1pdHRlcixcbiAgICBJbmplY3QsXG4gICAgUExBVEZPUk1fSUQsXG4gICAgT25DaGFuZ2VzLFxuICAgIFNpbXBsZUNoYW5nZXMsXG4gICAgT25EZXN0cm95XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSm95cmlkZVN0ZXAgfSBmcm9tICcuLi9tb2RlbHMvam95cmlkZS1zdGVwLmNsYXNzJztcbmltcG9ydCB7IEpveXJpZGVTdGVwc0NvbnRhaW5lclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9qb3lyaWRlLXN0ZXBzLWNvbnRhaW5lci5zZXJ2aWNlJztcbmltcG9ydCB7IEpveXJpZGVFcnJvciB9IGZyb20gJy4uL21vZGVscy9qb3lyaWRlLWVycm9yLmNsYXNzJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBEb21SZWZTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZG9tLnNlcnZpY2UnO1xuaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgVGVtcGxhdGVzU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3RlbXBsYXRlcy5zZXJ2aWNlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuXG5leHBvcnQgY29uc3QgTk9fUE9TSVRJT04gPSAnTk9fUE9TSVRJT04nO1xuXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ2pveXJpZGVTdGVwLCBbam95cmlkZVN0ZXBdJ1xufSlcbmV4cG9ydCBjbGFzcyBKb3lyaWRlRGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuICAgIEBJbnB1dCgnam95cmlkZVN0ZXAnKVxuICAgIG5hbWU6IHN0cmluZztcblxuICAgIEBJbnB1dCgpXG4gICAgbmV4dFN0ZXA/OiBzdHJpbmc7XG5cbiAgICBASW5wdXQoKVxuICAgIHRpdGxlPzogc3RyaW5nIHwgT2JzZXJ2YWJsZTxzdHJpbmc+O1xuXG4gICAgQElucHV0KClcbiAgICB0ZXh0Pzogc3RyaW5nIHwgT2JzZXJ2YWJsZTxzdHJpbmc+O1xuXG4gICAgQElucHV0KClcbiAgICBzdGVwUG9zaXRpb24/OiBzdHJpbmcgPSBOT19QT1NJVElPTjtcblxuICAgIEBJbnB1dCgpXG4gICAgc3RlcENvbnRlbnQ/OiBUZW1wbGF0ZVJlZjxhbnk+O1xuXG4gICAgQElucHV0KClcbiAgICBzdGVwQ29udGVudFBhcmFtcz86IE9iamVjdDtcblxuICAgIEBJbnB1dCgpXG4gICAgcHJldlRlbXBsYXRlPzogVGVtcGxhdGVSZWY8YW55PjtcblxuICAgIEBJbnB1dCgpXG4gICAgbmV4dFRlbXBsYXRlPzogVGVtcGxhdGVSZWY8YW55PjtcblxuICAgIEBJbnB1dCgpXG4gICAgZG9uZVRlbXBsYXRlPzogVGVtcGxhdGVSZWY8YW55PjtcblxuICAgIEBJbnB1dCgpXG4gICAgY291bnRlclRlbXBsYXRlPzogVGVtcGxhdGVSZWY8YW55PjtcblxuICAgIEBPdXRwdXQoKVxuICAgIHByZXY/OiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gICAgQE91dHB1dCgpXG4gICAgbmV4dD86IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgICBAT3V0cHV0KClcbiAgICBkb25lPzogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIHByaXZhdGUgd2luZG93UmVmOiBXaW5kb3c7XG4gICAgcHJpdmF0ZSBzdGVwOiBKb3lyaWRlU3RlcDtcbiAgICBwcml2YXRlIHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbltdID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBqb3lyaWRlU3RlcHNDb250YWluZXI6IEpveXJpZGVTdGVwc0NvbnRhaW5lclNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZixcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBkb21TZXJ2aWNlOiBEb21SZWZTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IHJvdXRlcjogUm91dGVyLFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IHRlbXBsYXRlU2VydmljZTogVGVtcGxhdGVzU2VydmljZSxcbiAgICAgICAgQEluamVjdChQTEFURk9STV9JRCkgcHJpdmF0ZSBwbGF0Zm9ybUlkOiBPYmplY3RcbiAgICApIHtcbiAgICAgICAgdGhpcy53aW5kb3dSZWYgPSB0aGlzLmRvbVNlcnZpY2UuZ2V0TmF0aXZlV2luZG93KCk7XG4gICAgICAgIHRoaXMuc3RlcCA9IG5ldyBKb3lyaWRlU3RlcCgpO1xuICAgIH1cblxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICAgICAgaWYgKCFpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSByZXR1cm47XG4gICAgICAgIGlmICh0aGlzLnByZXZUZW1wbGF0ZSkgdGhpcy50ZW1wbGF0ZVNlcnZpY2Uuc2V0UHJldkJ1dHRvbih0aGlzLnByZXZUZW1wbGF0ZSk7XG4gICAgICAgIGlmICh0aGlzLm5leHRUZW1wbGF0ZSkgdGhpcy50ZW1wbGF0ZVNlcnZpY2Uuc2V0TmV4dEJ1dHRvbih0aGlzLm5leHRUZW1wbGF0ZSk7XG4gICAgICAgIGlmICh0aGlzLmRvbmVUZW1wbGF0ZSkgdGhpcy50ZW1wbGF0ZVNlcnZpY2Uuc2V0RG9uZUJ1dHRvbih0aGlzLmRvbmVUZW1wbGF0ZSk7XG4gICAgICAgIGlmICh0aGlzLmNvdW50ZXJUZW1wbGF0ZSkgdGhpcy50ZW1wbGF0ZVNlcnZpY2Uuc2V0Q291bnRlcih0aGlzLmNvdW50ZXJUZW1wbGF0ZSk7XG4gICAgICAgIHRoaXMuc3RlcC5wb3NpdGlvbiA9IHRoaXMuc3RlcFBvc2l0aW9uO1xuICAgICAgICB0aGlzLnN0ZXAudGFyZ2V0Vmlld0NvbnRhaW5lciA9IHRoaXMudmlld0NvbnRhaW5lclJlZjtcbiAgICAgICAgdGhpcy5zZXRBc3luY0ZpZWxkcyh0aGlzLnN0ZXApO1xuICAgICAgICB0aGlzLnN0ZXAuc3RlcENvbnRlbnQgPSB0aGlzLnN0ZXBDb250ZW50O1xuICAgICAgICB0aGlzLnN0ZXAuc3RlcENvbnRlbnRQYXJhbXMgPSB0aGlzLnN0ZXBDb250ZW50UGFyYW1zO1xuICAgICAgICB0aGlzLnN0ZXAubmV4dENsaWNrZWQgPSB0aGlzLm5leHQ7XG4gICAgICAgIHRoaXMuc3RlcC5wcmV2Q2xpa2VkID0gdGhpcy5wcmV2O1xuICAgICAgICB0aGlzLnN0ZXAudG91ckRvbmUgPSB0aGlzLmRvbmU7XG4gICAgICAgIGlmICghdGhpcy5uYW1lKSB0aHJvdyBuZXcgSm95cmlkZUVycm9yKFwiQWxsIHRoZSBzdGVwcyBzaG91bGQgaGF2ZSB0aGUgJ2pveXJpZGVTdGVwJyBwcm9wZXJ0eSBzZXQgd2l0aCBhIGN1c3RvbSBuYW1lLlwiKTtcbiAgICAgICAgdGhpcy5zdGVwLm5hbWUgPSB0aGlzLm5hbWU7XG4gICAgICAgIHRoaXMuc3RlcC5yb3V0ZSA9IHRoaXMucm91dGVyLnVybC5zdWJzdHIoMCwgMSkgPT09ICcvJyA/IHRoaXMucm91dGVyLnVybC5zdWJzdHIoMSkgOiB0aGlzLnJvdXRlci51cmw7XG4gICAgICAgIHRoaXMuc3RlcC50cmFuc2Zvcm1Dc3NTdHlsZSA9IHRoaXMud2luZG93UmVmLmdldENvbXB1dGVkU3R5bGUodGhpcy52aWV3Q29udGFpbmVyUmVmLmVsZW1lbnQubmF0aXZlRWxlbWVudCkudHJhbnNmb3JtO1xuICAgICAgICB0aGlzLnN0ZXAuaXNFbGVtZW50T3JBbmNlc3RvckZpeGVkID1cbiAgICAgICAgICAgIHRoaXMuaXNFbGVtZW50Rml4ZWQodGhpcy52aWV3Q29udGFpbmVyUmVmLmVsZW1lbnQpIHx8XG4gICAgICAgICAgICB0aGlzLmlzQW5jZXN0b3JzRml4ZWQodGhpcy52aWV3Q29udGFpbmVyUmVmLmVsZW1lbnQubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50KTtcblxuICAgICAgICB0aGlzLmpveXJpZGVTdGVwc0NvbnRhaW5lci5hZGRTdGVwKHRoaXMuc3RlcCk7XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgICAgICBpZiAoY2hhbmdlc1sndGl0bGUnXSB8fCBjaGFuZ2VzWyd0ZXh0J10pIHtcbiAgICAgICAgICAgIHRoaXMuc2V0QXN5bmNGaWVsZHModGhpcy5zdGVwKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaXNFbGVtZW50Rml4ZWQoZWxlbWVudDogRWxlbWVudFJlZikge1xuICAgICAgICByZXR1cm4gdGhpcy53aW5kb3dSZWYuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50Lm5hdGl2ZUVsZW1lbnQpLnBvc2l0aW9uID09PSAnZml4ZWQnO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0QXN5bmNGaWVsZHMoc3RlcDogSm95cmlkZVN0ZXApIHtcbiAgICAgICAgaWYgKHRoaXMudGl0bGUgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSB7XG4gICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaChcbiAgICAgICAgICAgICAgICB0aGlzLnRpdGxlLnN1YnNjcmliZSh0aXRsZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHN0ZXAudGl0bGUubmV4dCh0aXRsZSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdGVwLnRpdGxlLm5leHQodGhpcy50aXRsZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudGV4dCBpbnN0YW5jZW9mIE9ic2VydmFibGUpIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKFxuICAgICAgICAgICAgICAgIHRoaXMudGV4dC5zdWJzY3JpYmUodGV4dCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHN0ZXAudGV4dC5uZXh0KHRleHQpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3RlcC50ZXh0Lm5leHQodGhpcy50ZXh0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaXNBbmNlc3RvcnNGaXhlZChuYXRpdmVFbGVtZW50OiBhbnkpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKCFuYXRpdmVFbGVtZW50IHx8ICFuYXRpdmVFbGVtZW50LnBhcmVudEVsZW1lbnQpIHJldHVybiBmYWxzZTtcbiAgICAgICAgbGV0IGlzRWxlbWVudEZpeGVkID0gdGhpcy53aW5kb3dSZWYuZ2V0Q29tcHV0ZWRTdHlsZShuYXRpdmVFbGVtZW50LnBhcmVudEVsZW1lbnQpLnBvc2l0aW9uID09PSAnZml4ZWQnO1xuICAgICAgICBpZiAobmF0aXZlRWxlbWVudC5ub2RlTmFtZSA9PT0gJ0JPRFknKSB7XG4gICAgICAgICAgICByZXR1cm4gaXNFbGVtZW50Rml4ZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlzRWxlbWVudEZpeGVkKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgZWxzZSByZXR1cm4gdGhpcy5pc0FuY2VzdG9yc0ZpeGVkKG5hdGl2ZUVsZW1lbnQucGFyZW50RWxlbWVudCk7XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5mb3JFYWNoKHN1YiA9PiB7XG4gICAgICAgICAgICBzdWIudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19
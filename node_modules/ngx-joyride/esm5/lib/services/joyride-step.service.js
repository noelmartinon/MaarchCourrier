import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { JoyrideBackdropService } from './joyride-backdrop.service';
import { EventListenerService } from './event-listener.service';
import { JoyrideStepsContainerService, StepActionType } from './joyride-steps-container.service';
import { DocumentService } from './document.service';
import { StepDrawerService } from './step-drawer.service';
import { DomRefService } from './dom.service';
import { NO_POSITION } from '../directives/joyride.directive';
import { JoyrideOptionsService } from './joyride-options.service';
import { Router } from '@angular/router';
import { ReplaySubject } from 'rxjs';
import { JoyrideStepDoesNotExist, JoyrideStepOutOfRange } from '../models/joyride-error.class';
import { LoggerService } from './logger.service';
var SCROLLBAR_SIZE = 20;
export var DISTANCE_FROM_TARGET = 15;
export var ARROW_SIZE = 10;
var JoyrideStepService = /** @class */ (function () {
    function JoyrideStepService(backDropService, eventListener, stepsContainerService, documentService, DOMService, stepDrawerService, optionsService, router, logger) {
        this.backDropService = backDropService;
        this.eventListener = eventListener;
        this.stepsContainerService = stepsContainerService;
        this.documentService = documentService;
        this.DOMService = DOMService;
        this.stepDrawerService = stepDrawerService;
        this.optionsService = optionsService;
        this.router = router;
        this.logger = logger;
        this.winTopPosition = 0;
        this.winBottomPosition = 0;
        this.stepsObserver = new ReplaySubject();
        this.initViewportPositions();
        this.subscribeToScrollEvents();
        this.subscribeToResizeEvents();
    }
    JoyrideStepService.prototype.initViewportPositions = function () {
        this.winTopPosition = 0;
        this.winBottomPosition = this.DOMService.getNativeWindow().innerHeight - SCROLLBAR_SIZE;
    };
    JoyrideStepService.prototype.subscribeToScrollEvents = function () {
        var _this = this;
        this.eventListener.startListeningScrollEvents();
        this.eventListener.scrollEvent.subscribe(function (scroll) {
            _this.winTopPosition = scroll.scrollY;
            _this.winBottomPosition = _this.winTopPosition + _this.DOMService.getNativeWindow().innerHeight - SCROLLBAR_SIZE;
            if (_this.currentStep)
                _this.backDropService.redraw(_this.currentStep, scroll);
        });
    };
    JoyrideStepService.prototype.subscribeToResizeEvents = function () {
        var _this = this;
        this.eventListener.resizeEvent.subscribe(function () {
            if (_this.currentStep)
                _this.backDropService.redrawTarget(_this.currentStep);
        });
    };
    JoyrideStepService.prototype.drawStep = function (step) {
        step.position = step.position === NO_POSITION ? this.optionsService.getStepDefaultPosition() : step.position;
        this.stepDrawerService.draw(step);
    };
    JoyrideStepService.prototype.startTour = function () {
        this.stepsObserver = new ReplaySubject();
        this.stepsContainerService.init();
        this.documentService.setDocumentHeight();
        this.tryShowStep(StepActionType.NEXT);
        this.eventListener.startListeningResizeEvents();
        this.subscribeToStepsUpdates();
        return this.stepsObserver.asObservable();
    };
    JoyrideStepService.prototype.close = function () {
        this.removeCurrentStep();
        this.notifyTourIsFinished();
        this.DOMService.getNativeWindow().scrollTo(0, 0);
        this.eventListener.stopListeningResizeEvents();
        this.backDropService.remove();
    };
    JoyrideStepService.prototype.prev = function () {
        this.removeCurrentStep();
        this.currentStep.prevCliked.emit();
        this.tryShowStep(StepActionType.PREV);
    };
    JoyrideStepService.prototype.next = function () {
        this.removeCurrentStep();
        this.currentStep.nextClicked.emit();
        this.tryShowStep(StepActionType.NEXT);
    };
    JoyrideStepService.prototype.navigateToStepPage = function (action) {
        var stepRoute = this.stepsContainerService.getStepRoute(action);
        if (stepRoute) {
            this.router.navigate([stepRoute]);
        }
    };
    JoyrideStepService.prototype.subscribeToStepsUpdates = function () {
        var _this = this;
        this.stepsContainerService.stepHasBeenModified.subscribe(function (updatedStep) {
            if (_this.currentStep && _this.currentStep.name === updatedStep.name) {
                _this.currentStep = updatedStep;
            }
        });
    };
    JoyrideStepService.prototype.tryShowStep = function (actionType) {
        var _this = this;
        this.navigateToStepPage(actionType);
        var timeout = this.optionsService.getWaitingTime();
        if (timeout > 100)
            this.backDropService.remove();
        setTimeout(function () {
            try {
                _this.showStep(actionType);
            }
            catch (error) {
                if (error instanceof JoyrideStepDoesNotExist) {
                    _this.tryShowStep(actionType);
                }
                else if (error instanceof JoyrideStepOutOfRange) {
                    _this.logger.error('Forcing the tour closure: First or Last step not found in the DOM.');
                    _this.close();
                }
                else {
                    throw new Error(error);
                }
            }
        }, timeout);
    };
    JoyrideStepService.prototype.showStep = function (actionType) {
        this.currentStep = this.stepsContainerService.get(actionType);
        if (this.currentStep == null)
            throw new JoyrideStepDoesNotExist('');
        // Scroll the element to get it visible if it's in a scrollable element
        this.scrollIfElementBeyondOtherElements();
        this.backDropService.draw(this.currentStep);
        this.drawStep(this.currentStep);
        this.scrollIfStepAndTargetAreNotVisible();
        this.notifyStepClicked(actionType);
    };
    JoyrideStepService.prototype.notifyStepClicked = function (actionType) {
        var stepInfo = {
            number: this.stepsContainerService.getStepNumber(this.currentStep.name),
            name: this.currentStep.name,
            route: this.currentStep.route,
            actionType: actionType
        };
        this.stepsObserver.next(stepInfo);
    };
    JoyrideStepService.prototype.notifyTourIsFinished = function () {
        if (this.currentStep)
            this.currentStep.tourDone.emit();
        this.stepsObserver.complete();
    };
    JoyrideStepService.prototype.removeCurrentStep = function () {
        if (this.currentStep)
            this.stepDrawerService.remove(this.currentStep);
    };
    JoyrideStepService.prototype.scrollIfStepAndTargetAreNotVisible = function () {
        this.scrollWhenTargetOrStepAreHiddenBottom();
        this.scrollWhenTargetOrStepAreHiddenTop();
    };
    JoyrideStepService.prototype.scrollWhenTargetOrStepAreHiddenBottom = function () {
        var totalTargetBottom = this.getMaxTargetAndStepBottomPosition();
        if (totalTargetBottom > this.winBottomPosition) {
            this.DOMService.getNativeWindow().scrollBy(0, totalTargetBottom - this.winBottomPosition);
        }
    };
    JoyrideStepService.prototype.scrollWhenTargetOrStepAreHiddenTop = function () {
        var totalTargetTop = this.getMaxTargetAndStepTopPosition();
        if (totalTargetTop < this.winTopPosition) {
            this.DOMService.getNativeWindow().scrollBy(0, totalTargetTop - this.winTopPosition);
        }
    };
    JoyrideStepService.prototype.getMaxTargetAndStepBottomPosition = function () {
        var targetAbsoluteTop = this.documentService.getElementAbsoluteTop(this.currentStep.targetViewContainer.element);
        if (this.currentStep.position === 'top') {
            return targetAbsoluteTop + this.currentStep.stepInstance.targetHeight;
        }
        else if (this.currentStep.position === 'bottom') {
            return (targetAbsoluteTop +
                this.currentStep.stepInstance.targetHeight +
                this.currentStep.stepInstance.stepHeight +
                ARROW_SIZE +
                DISTANCE_FROM_TARGET);
        }
        else if (this.currentStep.position === 'right' || this.currentStep.position === 'left') {
            return Math.max(targetAbsoluteTop + this.currentStep.stepInstance.targetHeight, targetAbsoluteTop + this.currentStep.stepInstance.targetHeight / 2 + this.currentStep.stepInstance.stepHeight / 2);
        }
    };
    JoyrideStepService.prototype.getMaxTargetAndStepTopPosition = function () {
        var targetAbsoluteTop = this.documentService.getElementAbsoluteTop(this.currentStep.targetViewContainer.element);
        if (this.currentStep.position === 'top') {
            return targetAbsoluteTop - (this.currentStep.stepInstance.stepHeight + ARROW_SIZE + DISTANCE_FROM_TARGET);
        }
        else if (this.currentStep.position === 'bottom') {
            return targetAbsoluteTop;
        }
        else if (this.currentStep.position === 'right' || this.currentStep.position === 'left') {
            return Math.min(targetAbsoluteTop, targetAbsoluteTop + this.currentStep.stepInstance.targetHeight / 2 - this.currentStep.stepInstance.stepHeight / 2);
        }
    };
    JoyrideStepService.prototype.scrollIfElementBeyondOtherElements = function () {
        if (this.isElementBeyondOthers() === 2) {
            this.documentService.scrollToTheTop(this.currentStep.targetViewContainer.element);
        }
        if (this.isElementBeyondOthers() === 2) {
            this.documentService.scrollToTheBottom(this.currentStep.targetViewContainer.element);
        }
        if (this.isElementBeyondOthers() === 1 && this.documentService.isParentScrollable(this.currentStep.targetViewContainer.element)) {
            this.documentService.scrollIntoView(this.currentStep.targetViewContainer.element, this.currentStep.isElementOrAncestorFixed);
        }
        if (this.isElementBeyondOthers() === 1 && this.documentService.isParentScrollable(this.currentStep.targetViewContainer.element)) {
            this.currentStep.targetViewContainer.element.nativeElement.scrollIntoView();
        }
    };
    JoyrideStepService.prototype.isElementBeyondOthers = function () {
        return this.documentService.isElementBeyondOthers(this.currentStep.targetViewContainer.element, this.currentStep.isElementOrAncestorFixed, 'backdrop');
    };
    JoyrideStepService.ctorParameters = function () { return [
        { type: JoyrideBackdropService },
        { type: EventListenerService },
        { type: JoyrideStepsContainerService },
        { type: DocumentService },
        { type: DomRefService },
        { type: StepDrawerService },
        { type: JoyrideOptionsService },
        { type: Router },
        { type: LoggerService }
    ]; };
    JoyrideStepService = __decorate([
        Injectable()
    ], JoyrideStepService);
    return JoyrideStepService;
}());
export { JoyrideStepService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiam95cmlkZS1zdGVwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtam95cmlkZS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9qb3lyaWRlLXN0ZXAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDakcsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQzlELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsYUFBYSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBRWpELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQy9GLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUVqRCxJQUFNLGNBQWMsR0FBRyxFQUFFLENBQUM7QUFFMUIsTUFBTSxDQUFDLElBQU0sb0JBQW9CLEdBQUcsRUFBRSxDQUFDO0FBQ3ZDLE1BQU0sQ0FBQyxJQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7QUFVN0I7SUFNSSw0QkFDcUIsZUFBdUMsRUFDdkMsYUFBbUMsRUFDbkMscUJB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LENBQUMsV0FBVyxDQUFDLHdCQUF3QixFQUN6QyxVQUFVLENBQ2IsQ0FBQztJQUNOLENBQUM7O2dCQWxOcUMsc0JBQXNCO2dCQUN4QixvQkFBb0I7Z0JBQ1osNEJBQTRCO2dCQUNsQyxlQUFlO2dCQUNwQixhQUFhO2dCQUNOLGlCQUFpQjtnQkFDcEIscUJBQXFCO2dCQUM3QixNQUFNO2dCQUNOLGFBQWE7O0lBZmpDLGtCQUFrQjtRQUQ5QixVQUFVLEVBQUU7T0FDQSxrQkFBa0IsQ0EwTjlCO0lBQUQseUJBQUM7Q0FBQSxBQTFORCxJQTBOQztTQTFOWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBKb3lyaWRlU3RlcCB9IGZyb20gJy4uL21vZGVscy9qb3lyaWRlLXN0ZXAuY2xhc3MnO1xuaW1wb3J0IHsgSm95cmlkZUJhY2tkcm9wU2VydmljZSB9IGZyb20gJy4vam95cmlkZS1iYWNrZHJvcC5zZXJ2aWNlJztcbmltcG9ydCB7IEV2ZW50TGlzdGVuZXJTZXJ2aWNlIH0gZnJvbSAnLi9ldmVudC1saXN0ZW5lci5zZXJ2aWNlJztcbmltcG9ydCB7IEpveXJpZGVTdGVwc0NvbnRhaW5lclNlcnZpY2UsIFN0ZXBBY3Rpb25UeXBlIH0gZnJvbSAnLi9qb3lyaWRlLXN0ZXBzLWNvbnRhaW5lci5zZXJ2aWNlJztcbmltcG9ydCB7IERvY3VtZW50U2VydmljZSB9IGZyb20gJy4vZG9jdW1lbnQuc2VydmljZSc7XG5pbXBvcnQgeyBTdGVwRHJhd2VyU2VydmljZSB9IGZyb20gJy4vc3RlcC1kcmF3ZXIuc2VydmljZSc7XG5pbXBvcnQgeyBEb21SZWZTZXJ2aWNlIH0gZnJvbSAnLi9kb20uc2VydmljZSc7XG5pbXBvcnQgeyBOT19QT1NJVElPTiB9IGZyb20gJy4uL2RpcmVjdGl2ZXMvam95cmlkZS5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgSm95cmlkZU9wdGlvbnNTZXJ2aWNlIH0gZnJvbSAnLi9qb3lyaWRlLW9wdGlvbnMuc2VydmljZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgUmVwbGF5U3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSm95cmlkZVN0ZXBJbmZvIH0gZnJvbSAnLi4vbW9kZWxzL2pveXJpZGUtc3RlcC1pbmZvLmNsYXNzJztcbmltcG9ydCB7IEpveXJpZGVTdGVwRG9lc05vdEV4aXN0LCBKb3lyaWRlU3RlcE91dE9mUmFuZ2UgfSBmcm9tICcuLi9tb2RlbHMvam95cmlkZS1lcnJvci5jbGFzcyc7XG5pbXBvcnQgeyBMb2dnZXJTZXJ2aWNlIH0gZnJvbSAnLi9sb2dnZXIuc2VydmljZSc7XG5cbmNvbnN0IFNDUk9MTEJBUl9TSVpFID0gMjA7XG5cbmV4cG9ydCBjb25zdCBESVNUQU5DRV9GUk9NX1RBUkdFVCA9IDE1O1xuZXhwb3J0IGNvbnN0IEFSUk9XX1NJWkUgPSAxMDtcblxuZXhwb3J0IGludGVyZmFjZSBJSm95cmlkZVN0ZXBTZXJ2aWNlIHtcbiAgICBzdGFydFRvdXIoKTogT2JzZXJ2YWJsZTxKb3lyaWRlU3RlcEluZm8+O1xuICAgIGNsb3NlKCk6IGFueTtcbiAgICBwcmV2KCk6IGFueTtcbiAgICBuZXh0KCk6IGFueTtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEpveXJpZGVTdGVwU2VydmljZSBpbXBsZW1lbnRzIElKb3lyaWRlU3RlcFNlcnZpY2Uge1xuICAgIHByaXZhdGUgY3VycmVudFN0ZXA6IEpveXJpZGVTdGVwO1xuICAgIHByaXZhdGUgd2luVG9wUG9zaXRpb246IG51bWJlciA9IDA7XG4gICAgcHJpdmF0ZSB3aW5Cb3R0b21Qb3NpdGlvbjogbnVtYmVyID0gMDtcbiAgICBwcml2YXRlIHN0ZXBzT2JzZXJ2ZXI6IFJlcGxheVN1YmplY3Q8Sm95cmlkZVN0ZXBJbmZvPiA9IG5ldyBSZXBsYXlTdWJqZWN0PEpveXJpZGVTdGVwSW5mbz4oKTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IGJhY2tEcm9wU2VydmljZTogSm95cmlkZUJhY2tkcm9wU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBldmVudExpc3RlbmVyOiBFdmVudExpc3RlbmVyU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBzdGVwc0NvbnRhaW5lclNlcnZpY2U6IEpveXJpZGVTdGVwc0NvbnRhaW5lclNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgZG9jdW1lbnRTZXJ2aWNlOiBEb2N1bWVudFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgRE9NU2VydmljZTogRG9tUmVmU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBzdGVwRHJhd2VyU2VydmljZTogU3RlcERyYXdlclNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgb3B0aW9uc1NlcnZpY2U6IEpveXJpZGVPcHRpb25zU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSByb3V0ZXI6IFJvdXRlcixcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXI6IExvZ2dlclNlcnZpY2VcbiAgICApIHtcbiAgICAgICAgdGhpcy5pbml0Vmlld3BvcnRQb3NpdGlvbnMoKTtcbiAgICAgICAgdGhpcy5zdWJzY3JpYmVUb1Njcm9sbEV2ZW50cygpO1xuICAgICAgICB0aGlzLnN1YnNjcmliZVRvUmVzaXplRXZlbnRzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0Vmlld3BvcnRQb3NpdGlvbnMoKSB7XG4gICAgICAgIHRoaXMud2luVG9wUG9zaXRpb24gPSAwO1xuICAgICAgICB0aGlzLndpbkJvdHRvbVBvc2l0aW9uID0gdGhpcy5ET01TZXJ2aWNlLmdldE5hdGl2ZVdpbmRvdygpLmlubmVySGVpZ2h0IC0gU0NST0xMQkFSX1NJWkU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdWJzY3JpYmVUb1Njcm9sbEV2ZW50cygpIHtcbiAgICAgICAgdGhpcy5ldmVudExpc3RlbmVyLnN0YXJ0TGlzdGVuaW5nU2Nyb2xsRXZlbnRzKCk7XG4gICAgICAgIHRoaXMuZXZlbnRMaXN0ZW5lci5zY3JvbGxFdmVudC5zdWJzY3JpYmUoc2Nyb2xsID0+IHtcbiAgICAgICAgICAgIHRoaXMud2luVG9wUG9zaXRpb24gPSBzY3JvbGwuc2Nyb2xsWTtcbiAgICAgICAgICAgIHRoaXMud2luQm90dG9tUG9zaXRpb24gPSB0aGlzLndpblRvcFBvc2l0aW9uICsgdGhpcy5ET01TZXJ2aWNlLmdldE5hdGl2ZVdpbmRvdygpLmlubmVySGVpZ2h0IC0gU0NST0xMQkFSX1NJWkU7XG4gICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50U3RlcCkgdGhpcy5iYWNrRHJvcFNlcnZpY2UucmVkcmF3KHRoaXMuY3VycmVudFN0ZXAsIHNjcm9sbCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3Vic2NyaWJlVG9SZXNpemVFdmVudHMoKSB7XG4gICAgICAgIHRoaXMuZXZlbnRMaXN0ZW5lci5yZXNpemVFdmVudC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudFN0ZXApIHRoaXMuYmFja0Ryb3BTZXJ2aWNlLnJlZHJhd1RhcmdldCh0aGlzLmN1cnJlbnRTdGVwKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmF3U3RlcChzdGVwOiBKb3lyaWRlU3RlcCkge1xuICAgICAgICBzdGVwLnBvc2l0aW9uID0gc3RlcC5wb3NpdGlvbiA9PT0gTk9fUE9TSVRJT04gPyB0aGlzLm9wdGlvbnNTZXJ2aWNlLmdldFN0ZXBEZWZhdWx0UG9zaXRpb24oKSA6IHN0ZXAucG9zaXRpb247XG4gICAgICAgIHRoaXMuc3RlcERyYXdlclNlcnZpY2UuZHJhdyhzdGVwKTtcbiAgICB9XG5cbiAgICBzdGFydFRvdXIoKTogT2JzZXJ2YWJsZTxKb3lyaWRlU3RlcEluZm8+IHtcbiAgICAgICAgdGhpcy5zdGVwc09ic2VydmVyID0gbmV3IFJlcGxheVN1YmplY3Q8Sm95cmlkZVN0ZXBJbmZvPigpO1xuICAgICAgICB0aGlzLnN0ZXBzQ29udGFpbmVyU2VydmljZS5pbml0KCk7XG4gICAgICAgIHRoaXMuZG9jdW1lbnRTZXJ2aWNlLnNldERvY3VtZW50SGVpZ2h0KCk7XG5cbiAgICAgICAgdGhpcy50cnlTaG93U3RlcChTdGVwQWN0aW9uVHlwZS5ORVhUKTtcbiAgICAgICAgdGhpcy5ldmVudExpc3RlbmVyLnN0YXJ0TGlzdGVuaW5nUmVzaXplRXZlbnRzKCk7XG4gICAgICAgIHRoaXMuc3Vic2NyaWJlVG9TdGVwc1VwZGF0ZXMoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RlcHNPYnNlcnZlci5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICBjbG9zZSgpIHtcbiAgICAgICAgdGhpcy5yZW1vdmVDdXJyZW50U3RlcCgpO1xuICAgICAgICB0aGlzLm5vdGlmeVRvdXJJc0ZpbmlzaGVkKCk7XG4gICAgICAgIHRoaXMuRE9NU2VydmljZS5nZXROYXRpdmVXaW5kb3coKS5zY3JvbGxUbygwLCAwKTtcbiAgICAgICAgdGhpcy5ldmVudExpc3RlbmVyLnN0b3BMaXN0ZW5pbmdSZXNpemVFdmVudHMoKTtcbiAgICAgICAgdGhpcy5iYWNrRHJvcFNlcnZpY2UucmVtb3ZlKCk7XG4gICAgfVxuXG4gICAgcHJldigpIHtcbiAgICAgICAgdGhpcy5yZW1vdmVDdXJyZW50U3RlcCgpO1xuICAgICAgICB0aGlzLmN1cnJlbnRTdGVwLnByZXZDbGlrZWQuZW1pdCgpO1xuICAgICAgICB0aGlzLnRyeVNob3dTdGVwKFN0ZXBBY3Rpb25UeXBlLlBSRVYpO1xuICAgIH1cblxuICAgIG5leHQoKSB7XG4gICAgICAgIHRoaXMucmVtb3ZlQ3VycmVudFN0ZXAoKTtcbiAgICAgICAgdGhpcy5jdXJyZW50U3RlcC5uZXh0Q2xpY2tlZC5lbWl0KCk7XG4gICAgICAgIHRoaXMudHJ5U2hvd1N0ZXAoU3RlcEFjdGlvblR5cGUuTkVYVCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBuYXZpZ2F0ZVRvU3RlcFBhZ2UoYWN0aW9uOiBTdGVwQWN0aW9uVHlwZSkge1xuICAgICAgICBsZXQgc3RlcFJvdXRlID0gdGhpcy5zdGVwc0NvbnRhaW5lclNlcnZpY2UuZ2V0U3RlcFJvdXRlKGFjdGlvbik7XG4gICAgICAgIGlmIChzdGVwUm91dGUpIHtcbiAgICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFtzdGVwUm91dGVdKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgc3Vic2NyaWJlVG9TdGVwc1VwZGF0ZXMoKSB7XG4gICAgICAgIHRoaXMuc3RlcHNDb250YWluZXJTZXJ2aWNlLnN0ZXBIYXNCZWVuTW9kaWZpZWQuc3Vic2NyaWJlKHVwZGF0ZWRTdGVwID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRTdGVwICYmIHRoaXMuY3VycmVudFN0ZXAubmFtZSA9PT0gdXBkYXRlZFN0ZXAubmFtZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFN0ZXAgPSB1cGRhdGVkU3RlcDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0cnlTaG93U3RlcChhY3Rpb25UeXBlOiBTdGVwQWN0aW9uVHlwZSkge1xuICAgICAgICB0aGlzLm5hdmlnYXRlVG9TdGVwUGFnZShhY3Rpb25UeXBlKTtcbiAgICAgICAgY29uc3QgdGltZW91dCA9IHRoaXMub3B0aW9uc1NlcnZpY2UuZ2V0V2FpdGluZ1RpbWUoKTtcbiAgICAgICAgaWYgKHRpbWVvdXQgPiAxMDApIHRoaXMuYmFja0Ryb3BTZXJ2aWNlLnJlbW92ZSgpO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zaG93U3RlcChhY3Rpb25UeXBlKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgSm95cmlkZVN0ZXBEb2VzTm90RXhpc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50cnlTaG93U3RlcChhY3Rpb25UeXBlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yIGluc3RhbmNlb2YgSm95cmlkZVN0ZXBPdXRPZlJhbmdlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdGb3JjaW5nIHRoZSB0b3VyIGNsb3N1cmU6IEZpcnN0IG9yIExhc3Qgc3RlcCBub3QgZm91bmQgaW4gdGhlIERPTS4nKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LCB0aW1lb3V0KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNob3dTdGVwKGFjdGlvblR5cGU6IFN0ZXBBY3Rpb25UeXBlKSB7XG4gICAgICAgIHRoaXMuY3VycmVudFN0ZXAgPSB0aGlzLnN0ZXBzQ29udGFpbmVyU2VydmljZS5nZXQoYWN0aW9uVHlwZSk7XG5cbiAgICAgICAgaWYgKHRoaXMuY3VycmVudFN0ZXAgPT0gbnVsbCkgdGhyb3cgbmV3IEpveXJpZGVTdGVwRG9lc05vdEV4aXN0KCcnKTtcbiAgICAgICAgLy8gU2Nyb2xsIHRoZSBlbGVtZW50IHRvIGdldCBpdCB2aXNpYmxlIGlmIGl0J3MgaW4gYSBzY3JvbGxhYmxlIGVsZW1lbnRcbiAgICAgICAgdGhpcy5zY3JvbGxJZkVsZW1lbnRCZXlvbmRPdGhlckVsZW1lbnRzKCk7XG4gICAgICAgIHRoaXMuYmFja0Ryb3BTZXJ2aWNlLmRyYXcodGhpcy5jdXJyZW50U3RlcCk7XG4gICAgICAgIHRoaXMuZHJhd1N0ZXAodGhpcy5jdXJyZW50U3RlcCk7XG4gICAgICAgIHRoaXMuc2Nyb2xsSWZTdGVwQW5kVGFyZ2V0QXJlTm90VmlzaWJsZSgpO1xuICAgICAgICB0aGlzLm5vdGlmeVN0ZXBDbGlja2VkKGFjdGlvblR5cGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgbm90aWZ5U3RlcENsaWNrZWQoYWN0aW9uVHlwZTogU3RlcEFjdGlvblR5cGUpIHtcbiAgICAgICAgbGV0IHN0ZXBJbmZvOiBKb3lyaWRlU3RlcEluZm8gPSB7XG4gICAgICAgICAgICBudW1iZXI6IHRoaXMuc3RlcHNDb250YWluZXJTZXJ2aWNlLmdldFN0ZXBOdW1iZXIodGhpcy5jdXJyZW50U3RlcC5uYW1lKSxcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuY3VycmVudFN0ZXAubmFtZSxcbiAgICAgICAgICAgIHJvdXRlOiB0aGlzLmN1cnJlbnRTdGVwLnJvdXRlLFxuICAgICAgICAgICAgYWN0aW9uVHlwZVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnN0ZXBzT2JzZXJ2ZXIubmV4dChzdGVwSW5mbyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBub3RpZnlUb3VySXNGaW5pc2hlZCgpIHtcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudFN0ZXApIHRoaXMuY3VycmVudFN0ZXAudG91ckRvbmUuZW1pdCgpO1xuICAgICAgICB0aGlzLnN0ZXBzT2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICB9XG4gICAgcHJpdmF0ZSByZW1vdmVDdXJyZW50U3RlcCgpIHtcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudFN0ZXApIHRoaXMuc3RlcERyYXdlclNlcnZpY2UucmVtb3ZlKHRoaXMuY3VycmVudFN0ZXApO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2Nyb2xsSWZTdGVwQW5kVGFyZ2V0QXJlTm90VmlzaWJsZSgpIHtcbiAgICAgICAgdGhpcy5zY3JvbGxXaGVuVGFyZ2V0T3JTdGVwQXJlSGlkZGVuQm90dG9tKCk7XG4gICAgICAgIHRoaXMuc2Nyb2xsV2hlblRhcmdldE9yU3RlcEFyZUhpZGRlblRvcCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2Nyb2xsV2hlblRhcmdldE9yU3RlcEFyZUhpZGRlbkJvdHRvbSgpIHtcbiAgICAgICAgbGV0IHRvdGFsVGFyZ2V0Qm90dG9tID0gdGhpcy5nZXRNYXhUYXJnZXRBbmRTdGVwQm90dG9tUG9zaXRpb24oKTtcbiAgICAgICAgaWYgKHRvdGFsVGFyZ2V0Qm90dG9tID4gdGhpcy53aW5Cb3R0b21Qb3NpdGlvbikge1xuICAgICAgICAgICAgdGhpcy5ET01TZXJ2aWNlLmdldE5hdGl2ZVdpbmRvdygpLnNjcm9sbEJ5KDAsIHRvdGFsVGFyZ2V0Qm90dG9tIC0gdGhpcy53aW5Cb3R0b21Qb3NpdGlvbik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHNjcm9sbFdoZW5UYXJnZXRPclN0ZXBBcmVIaWRkZW5Ub3AoKSB7XG4gICAgICAgIGxldCB0b3RhbFRhcmdldFRvcCA9IHRoaXMuZ2V0TWF4VGFyZ2V0QW5kU3RlcFRvcFBvc2l0aW9uKCk7XG4gICAgICAgIGlmICh0b3RhbFRhcmdldFRvcCA8IHRoaXMud2luVG9wUG9zaXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuRE9NU2VydmljZS5nZXROYXRpdmVXaW5kb3coKS5zY3JvbGxCeSgwLCB0b3RhbFRhcmdldFRvcCAtIHRoaXMud2luVG9wUG9zaXRpb24pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRNYXhUYXJnZXRBbmRTdGVwQm90dG9tUG9zaXRpb24oKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IHRhcmdldEFic29sdXRlVG9wID0gdGhpcy5kb2N1bWVudFNlcnZpY2UuZ2V0RWxlbWVudEFic29sdXRlVG9wKHRoaXMuY3VycmVudFN0ZXAudGFyZ2V0Vmlld0NvbnRhaW5lci5lbGVtZW50KTtcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudFN0ZXAucG9zaXRpb24gPT09ICd0b3AnKSB7XG4gICAgICAgICAgICByZXR1cm4gdGFyZ2V0QWJzb2x1dGVUb3AgKyB0aGlzLmN1cnJlbnRTdGVwLnN0ZXBJbnN0YW5jZS50YXJnZXRIZWlnaHQ7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5jdXJyZW50U3RlcC5wb3NpdGlvbiA9PT0gJ2JvdHRvbScpIHtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgdGFyZ2V0QWJzb2x1dGVUb3AgK1xuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFN0ZXAuc3RlcEluc3RhbmNlLnRhcmdldEhlaWdodCArXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50U3RlcC5zdGVwSW5zdGFuY2Uuc3RlcEhlaWdodCArXG4gICAgICAgICAgICAgICAgQVJST1dfU0laRSArXG4gICAgICAgICAgICAgICAgRElTVEFOQ0VfRlJPTV9UQVJHRVRcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5jdXJyZW50U3RlcC5wb3NpdGlvbiA9PT0gJ3JpZ2h0JyB8fCB0aGlzLmN1cnJlbnRTdGVwLnBvc2l0aW9uID09PSAnbGVmdCcpIHtcbiAgICAgICAgICAgIHJldHVybiBNYXRoLm1heChcbiAgICAgICAgICAgICAgICB0YXJnZXRBYnNvbHV0ZVRvcCArIHRoaXMuY3VycmVudFN0ZXAuc3RlcEluc3RhbmNlLnRhcmdldEhlaWdodCxcbiAgICAgICAgICAgICAgICB0YXJnZXRBYnNvbHV0ZVRvcCArIHRoaXMuY3VycmVudFN0ZXAuc3RlcEluc3RhbmNlLnRhcmdldEhlaWdodCAvIDIgKyB0aGlzLmN1cnJlbnRTdGVwLnN0ZXBJbnN0YW5jZS5zdGVwSGVpZ2h0IC8gMlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TWF4VGFyZ2V0QW5kU3RlcFRvcFBvc2l0aW9uKCkge1xuICAgICAgICBsZXQgdGFyZ2V0QWJzb2x1dGVUb3AgPSB0aGlzLmRvY3VtZW50U2VydmljZS5nZXRFbGVtZW50QWJzb2x1dGVUb3AodGhpcy5jdXJyZW50U3RlcC50YXJnZXRWaWV3Q29udGFpbmVyLmVsZW1lbnQpO1xuICAgICAgICBpZiAodGhpcy5jdXJyZW50U3RlcC5wb3NpdGlvbiA9PT0gJ3RvcCcpIHtcbiAgICAgICAgICAgIHJldHVybiB0YXJnZXRBYnNvbHV0ZVRvcCAtICh0aGlzLmN1cnJlbnRTdGVwLnN0ZXBJbnN0YW5jZS5zdGVwSGVpZ2h0ICsgQVJST1dfU0laRSArIERJU1RBTkNFX0ZST01fVEFSR0VUKTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmN1cnJlbnRTdGVwLnBvc2l0aW9uID09PSAnYm90dG9tJykge1xuICAgICAgICAgICAgcmV0dXJuIHRhcmdldEFic29sdXRlVG9wO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY3VycmVudFN0ZXAucG9zaXRpb24gPT09ICdyaWdodCcgfHwgdGhpcy5jdXJyZW50U3RlcC5wb3NpdGlvbiA9PT0gJ2xlZnQnKSB7XG4gICAgICAgICAgICByZXR1cm4gTWF0aC5taW4oXG4gICAgICAgICAgICAgICAgdGFyZ2V0QWJzb2x1dGVUb3AsXG4gICAgICAgICAgICAgICAgdGFyZ2V0QWJzb2x1dGVUb3AgKyB0aGlzLmN1cnJlbnRTdGVwLnN0ZXBJbnN0YW5jZS50YXJnZXRIZWlnaHQgLyAyIC0gdGhpcy5jdXJyZW50U3RlcC5zdGVwSW5zdGFuY2Uuc3RlcEhlaWdodCAvIDJcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHNjcm9sbElmRWxlbWVudEJleW9uZE90aGVyRWxlbWVudHMoKSB7XG4gICAgICAgIGlmICh0aGlzLmlzRWxlbWVudEJleW9uZE90aGVycygpID09PSAyKSB7XG4gICAgICAgICAgICB0aGlzLmRvY3VtZW50U2VydmljZS5zY3JvbGxUb1RoZVRvcCh0aGlzLmN1cnJlbnRTdGVwLnRhcmdldFZpZXdDb250YWluZXIuZWxlbWVudCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuaXNFbGVtZW50QmV5b25kT3RoZXJzKCkgPT09IDIpIHtcbiAgICAgICAgICAgIHRoaXMuZG9jdW1lbnRTZXJ2aWNlLnNjcm9sbFRvVGhlQm90dG9tKHRoaXMuY3VycmVudFN0ZXAudGFyZ2V0Vmlld0NvbnRhaW5lci5lbGVtZW50KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5pc0VsZW1lbnRCZXlvbmRPdGhlcnMoKSA9PT0gMSAmJiB0aGlzLmRvY3VtZW50U2VydmljZS5pc1BhcmVudFNjcm9sbGFibGUodGhpcy5jdXJyZW50U3RlcC50YXJnZXRWaWV3Q29udGFpbmVyLmVsZW1lbnQpKSB7XG4gICAgICAgICAgICB0aGlzLmRvY3VtZW50U2VydmljZS5zY3JvbGxJbnRvVmlldyh0aGlzLmN1cnJlbnRTdGVwLnRhcmdldFZpZXdDb250YWluZXIuZWxlbWVudCwgdGhpcy5jdXJyZW50U3RlcC5pc0VsZW1lbnRPckFuY2VzdG9yRml4ZWQpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmlzRWxlbWVudEJleW9uZE90aGVycygpID09PSAxICYmIHRoaXMuZG9jdW1lbnRTZXJ2aWNlLmlzUGFyZW50U2Nyb2xsYWJsZSh0aGlzLmN1cnJlbnRTdGVwLnRhcmdldFZpZXdDb250YWluZXIuZWxlbWVudCkpIHtcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFN0ZXAudGFyZ2V0Vmlld0NvbnRhaW5lci5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuc2Nyb2xsSW50b1ZpZXcoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaXNFbGVtZW50QmV5b25kT3RoZXJzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudFNlcnZpY2UuaXNFbGVtZW50QmV5b25kT3RoZXJzKFxuICAgICAgICAgICAgdGhpcy5jdXJyZW50U3RlcC50YXJnZXRWaWV3Q29udGFpbmVyLmVsZW1lbnQsXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRTdGVwLmlzRWxlbWVudE9yQW5jZXN0b3JGaXhlZCxcbiAgICAgICAgICAgICdiYWNrZHJvcCdcbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=
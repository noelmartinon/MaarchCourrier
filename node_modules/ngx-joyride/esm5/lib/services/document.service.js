import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { DomRefService } from './dom.service';
var DocumentService = /** @class */ (function () {
    function DocumentService(DOMService) {
        this.DOMService = DOMService;
        this.setDocumentHeight();
        if (!document.elementsFromPoint) {
            // IE 11 - Edge browsers
            document.elementsFromPoint = this.elementsFromPoint.bind(this);
        }
    }
    DocumentService.prototype.getElementFixedTop = function (elementRef) {
        return elementRef.nativeElement.getBoundingClientRect().top;
    };
    DocumentService.prototype.getElementFixedLeft = function (elementRef) {
        return elementRef.nativeElement.getBoundingClientRect().left;
    };
    DocumentService.prototype.getElementAbsoluteTop = function (elementRef) {
        var scrollOffsets = this.getScrollOffsets();
        return (elementRef.nativeElement.getBoundingClientRect().top +
            scrollOffsets.y);
    };
    DocumentService.prototype.getElementAbsoluteLeft = function (elementRef) {
        var scrollOffsets = this.getScrollOffsets();
        return (elementRef.nativeElement.getBoundingClientRect().left +
            scrollOffsets.x);
    };
    DocumentService.prototype.setDocumentHeight = function () {
        this.documentHeight = this.calculateDocumentHeight();
    };
    DocumentService.prototype.getDocumentHeight = function () {
        return this.documentHeight;
    };
    DocumentService.prototype.isParentScrollable = function (elementRef) {
        return (this.getFirstScrollableParent(elementRef.nativeElement) !==
            this.DOMService.getNativeDocument().body);
    };
    DocumentService.prototype.isElementBeyondOthers = function (elementRef, isElementFixed, keywordToDiscard) {
        var x1 = isElementFixed
            ? this.getElementFixedLeft(elementRef)
            : this.getElementAbsoluteLeft(elementRef);
        var y1 = isElementFixed
            ? this.getElementFixedTop(elementRef)
            : this.getElementAbsoluteTop(elementRef);
        var x2 = x1 + elementRef.nativeElement.getBoundingClientRect().width - 1;
        var y2 = y1 + elementRef.nativeElement.getBoundingClientRect().height - 1;
        var elements1 = this.DOMService.getNativeDocument().elementsFromPoint(x1, y1);
        var elements2 = this.DOMService.getNativeDocument().elementsFromPoint(x2, y2);
        if (elements1.length === 0 && elements2.length === 0)
            return 1;
        if (this.getFirstElementWithoutKeyword(elements1, keywordToDiscard) !==
            elementRef.nativeElement ||
            this.getFirstElementWithoutKeyword(elements2, keywordToDiscard) !==
                elementRef.nativeElement) {
            return 2;
        }
        return 3;
    };
    DocumentService.prototype.scrollIntoView = function (elementRef, isElementFixed) {
        var firstScrollableParent = this.getFirstScrollableParent(elementRef.nativeElement);
        var top = isElementFixed
            ? this.getElementFixedTop(elementRef)
            : this.getElementAbsoluteTop(elementRef);
        if (firstScrollableParent !== this.DOMService.getNativeDocument().body) {
            if (firstScrollableParent.scrollTo) {
                firstScrollableParent.scrollTo(0, top - 150);
            }
            else {
                // IE 11 - Edge browsers
                firstScrollableParent.scrollTop = top - 150;
            }
        }
        else {
            this.DOMService.getNativeWindow().scrollTo(0, top - 150);
        }
    };
    DocumentService.prototype.scrollToTheTop = function (elementRef) {
        var firstScrollableParent = this.getFirstScrollableParent(elementRef.nativeElement);
        if (firstScrollableParent !== this.DOMService.getNativeDocument().body) {
            if (firstScrollableParent.scrollTo) {
                firstScrollableParent.scrollTo(0, 0);
            }
            else {
                // IE 11 - Edge browsers
                firstScrollableParent.scrollTop = 0;
            }
        }
        else {
            this.DOMService.getNativeWindow().scrollTo(0, 0);
        }
    };
    DocumentService.prototype.scrollToTheBottom = function (elementRef) {
        var firstScrollableParent = this.getFirstScrollableParent(elementRef.nativeElement);
        if (firstScrollableParent !== this.DOMService.getNativeDocument().body) {
            if (firstScrollableParent.scrollTo) {
                firstScrollableParent.scrollTo(0, this.DOMService.getNativeDocument().body.scrollHeight);
            }
            else {
                // IE 11 - Edge browsers
                firstScrollableParent.scrollTop =
                    firstScrollableParent.scrollHeight -
                        firstScrollableParent.clientHeight;
            }
        }
        else {
            this.DOMService.getNativeWindow().scrollTo(0, this.DOMService.getNativeDocument().body.scrollHeight);
        }
    };
    DocumentService.prototype.getFirstScrollableParent = function (node) {
        var _this = this;
        var regex = /(auto|scroll|overlay)/;
        var style = function (node, prop) {
            return _this.DOMService.getNativeWindow()
                .getComputedStyle(node, null)
                .getPropertyValue(prop);
        };
        var scroll = function (node) {
            return regex.test(style(node, 'overflow') +
                style(node, 'overflow-y') +
                style(node, 'overflow-x'));
        };
        var scrollparent = function (node) {
            return !node || node === _this.DOMService.getNativeDocument().body
                ? _this.DOMService.getNativeDocument().body
                : scroll(node)
                    ? node
                    : scrollparent(node.parentNode);
        };
        return scrollparent(node);
    };
    DocumentService.prototype.calculateDocumentHeight = function () {
        var documentRef = this.DOMService.getNativeDocument();
        return Math.max(documentRef.body.scrollHeight, documentRef.documentElement.scrollHeight, documentRef.body.offsetHeight, documentRef.documentElement.offsetHeight, documentRef.body.clientHeight, documentRef.documentElement.clientHeight);
    };
    DocumentService.prototype.getScrollOffsets = function () {
        var winReference = this.DOMService.getNativeWindow();
        var docReference = this.DOMService.getNativeDocument();
        // This works for all browsers except IE versions 8 and before
        if (winReference.pageXOffset != null)
            return { x: winReference.pageXOffset, y: winReference.pageYOffset };
        // For IE (or any browser) in Standards mode
        if (docReference.compatMode == 'CSS1Compat')
            return {
                x: docReference.documentElement.scrollLeft,
                y: docReference.documentElement.scrollTop
            };
        // For browsers in Quirks mode
        return {
            x: docReference.body.scrollLeft,
            y: docReference.body.scrollTop
        };
    };
    DocumentService.prototype.elementsFromPoint = function (x, y) {
        var parents = [];
        var parent = void 0;
        do {
            var elem = this.DOMService.getNativeDocument().elementFromPoint(x, y);
            if (elem && parent !== elem) {
                parent = elem;
                parents.push(parent);
                parent.style.pointerEvents = 'none';
            }
            else {
                parent = false;
            }
        } while (parent);
        parents.forEach(function (parent) {
            return (parent.style.pointerEvents = 'all');
        });
        return parents;
    };
    DocumentService.prototype.getFirstElementWithoutKeyword = function (elements, keyword) {
        while (elements[0] &&
            elements[0].classList.toString().includes(keyword)) {
            elements.shift();
        }
        return elements[0];
    };
    DocumentService.ctorParameters = function () { return [
        { type: DomRefService }
    ]; };
    DocumentService = __decorate([
        Injectable()
    ], DocumentService);
    return DocumentService;
}());
export { DocumentService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jdW1lbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1qb3lyaWRlLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2RvY3VtZW50LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQWMsTUFBTSxlQUFlLENBQUM7QUFDdkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQXlCOUM7SUFHSSx5QkFBNkIsVUFBeUI7UUFBekIsZUFBVSxHQUFWLFVBQVUsQ0FBZTtRQUNsRCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFpQixFQUFFO1lBQzdCLHdCQUF3QjtZQUN4QixRQUFRLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNsRTtJQUNMLENBQUM7SUFFRCw0Q0FBa0IsR0FBbEIsVUFBbUIsVUFBc0I7UUFDckMsT0FBTyxVQUFVLENBQUMsYUFBYSxDQUFDLHFCQUFxQixFQUFFLENBQUMsR0FBRyxDQUFDO0lBQ2hFLENBQUM7SUFFRCw2Q0FBbUIsR0FBbkIsVUFBb0IsVUFBc0I7UUFDdEMsT0FBTyxVQUFVLENBQUMsYUFBYSxDQUFDLHFCQUFxQixFQUFFLENBQUMsSUFBSSxDQUFDO0lBQ2pFLENBQUM7SUFFRCwrQ0FBcUIsR0FBckIsVUFBc0IsVUFBc0I7UUFDeEMsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDOUMsT0FBTyxDQUNILFVBQVUsQ0FBQyxhQUFhLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxHQUFHO1lBQ3BELGFBQWEsQ0FBQyxDQUFDLENBQ2xCLENBQUM7SUFDTixDQUFDO0lBRUQsZ0RBQXNCLEdBQXRCLFVBQXVCLFVBQXNCO1FBQ3pDLElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFB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SDdDLGVBQWU7UUFEM0IsVUFBVSxFQUFFO09BQ0EsZUFBZSxDQXNQM0I7SUFBRCxzQkFBQztDQUFBLEFBdFBELElBc1BDO1NBdFBZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBEb21SZWZTZXJ2aWNlIH0gZnJvbSAnLi9kb20uc2VydmljZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSURvY3VtZW50U2VydmljZSB7XG4gICAgZ2V0RWxlbWVudEZpeGVkVG9wKGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpOiBudW1iZXI7XG5cbiAgICBnZXRFbGVtZW50Rml4ZWRMZWZ0KGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpO1xuXG4gICAgZ2V0RWxlbWVudEFic29sdXRlVG9wKGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpO1xuXG4gICAgZ2V0RWxlbWVudEFic29sdXRlTGVmdChlbGVtZW50UmVmOiBFbGVtZW50UmVmKTtcblxuICAgIHNldERvY3VtZW50SGVpZ2h0KCk7XG5cbiAgICBnZXREb2N1bWVudEhlaWdodCgpOiBudW1iZXI7XG4gICAgaXNQYXJlbnRTY3JvbGxhYmxlKGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpOiBib29sZWFuO1xuICAgIGlzRWxlbWVudEJleW9uZE90aGVycyhcbiAgICAgICAgZWxlbWVudFJlZjogRWxlbWVudFJlZixcbiAgICAgICAgaXNFbGVtZW50Rml4ZWQ6IGJvb2xlYW4sXG4gICAgICAgIGtleXdvcmRUb0Rpc2NhcmQ6IHN0cmluZ1xuICAgICk6IG51bWJlcjtcbiAgICBzY3JvbGxUb1RoZVRvcChlbGVtZW50UmVmOiBFbGVtZW50UmVmKTogdm9pZDtcbiAgICBzY3JvbGxUb1RoZUJvdHRvbShlbGVtZW50UmVmOiBFbGVtZW50UmVmKTogdm9pZDtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERvY3VtZW50U2VydmljZSBpbXBsZW1lbnRzIElEb2N1bWVudFNlcnZpY2Uge1xuICAgIHByaXZhdGUgZG9jdW1lbnRIZWlnaHQ6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgRE9NU2VydmljZTogRG9tUmVmU2VydmljZSkge1xuICAgICAgICB0aGlzLnNldERvY3VtZW50SGVpZ2h0KCk7XG4gICAgICAgIGlmICghZG9jdW1lbnQuZWxlbWVudHNGcm9tUG9pbnQpIHtcbiAgICAgICAgICAgIC8vIElFIDExIC0gRWRnZSBicm93c2Vyc1xuICAgICAgICAgICAgZG9jdW1lbnQuZWxlbWVudHNGcm9tUG9pbnQgPSB0aGlzLmVsZW1lbnRzRnJvbVBvaW50LmJpbmQodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRFbGVtZW50Rml4ZWRUb3AoZWxlbWVudFJlZjogRWxlbWVudFJlZikge1xuICAgICAgICByZXR1cm4gZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcDtcbiAgICB9XG5cbiAgICBnZXRFbGVtZW50Rml4ZWRMZWZ0KGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpIHtcbiAgICAgICAgcmV0dXJuIGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0O1xuICAgIH1cblxuICAgIGdldEVsZW1lbnRBYnNvbHV0ZVRvcChlbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7XG4gICAgICAgIGNvbnN0IHNjcm9sbE9mZnNldHMgPSB0aGlzLmdldFNjcm9sbE9mZnNldHMoKTtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3AgK1xuICAgICAgICAgICAgc2Nyb2xsT2Zmc2V0cy55XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgZ2V0RWxlbWVudEFic29sdXRlTGVmdChlbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7XG4gICAgICAgIGNvbnN0IHNjcm9sbE9mZnNldHMgPSB0aGlzLmdldFNjcm9sbE9mZnNldHMoKTtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0ICtcbiAgICAgICAgICAgIHNjcm9sbE9mZnNldHMueFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHNldERvY3VtZW50SGVpZ2h0KCkge1xuICAgICAgICB0aGlzLmRvY3VtZW50SGVpZ2h0ID0gdGhpcy5jYWxjdWxhdGVEb2N1bWVudEhlaWdodCgpO1xuICAgIH1cblxuICAgIGdldERvY3VtZW50SGVpZ2h0KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudEhlaWdodDtcbiAgICB9XG5cbiAgICBpc1BhcmVudFNjcm9sbGFibGUoZWxlbWVudFJlZjogRWxlbWVudFJlZik6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgdGhpcy5nZXRGaXJzdFNjcm9sbGFibGVQYXJlbnQoZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KSAhPT1cbiAgICAgICAgICAgIHRoaXMuRE9NU2VydmljZS5nZXROYXRpdmVEb2N1bWVudCgpLmJvZHlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpc0VsZW1lbnRCZXlvbmRPdGhlcnMoXG4gICAgICAgIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXG4gICAgICAgIGlzRWxlbWVudEZpeGVkOiBib29sZWFuLFxuICAgICAgICBrZXl3b3JkVG9EaXNjYXJkOiBzdHJpbmdcbiAgICApIHtcbiAgICAgICAgY29uc3QgeDEgPSBpc0VsZW1lbnRGaXhlZFxuICAgICAgICAgICAgPyB0aGlzLmdldEVsZW1lbnRGaXhlZExlZnQoZWxlbWVudFJlZilcbiAgICAgICAgICAgIDogdGhpcy5nZXRFbGVtZW50QWJzb2x1dGVMZWZ0KGVsZW1lbnRSZWYpO1xuICAgICAgICBjb25zdCB5MSA9IGlzRWxlbWVudEZpeGVkXG4gICAgICAgICAgICA/IHRoaXMuZ2V0RWxlbWVudEZpeGVkVG9wKGVsZW1lbnRSZWYpXG4gICAgICAgICAgICA6IHRoaXMuZ2V0RWxlbWVudEFic29sdXRlVG9wKGVsZW1lbnRSZWYpO1xuICAgICAgICBjb25zdCB4MiA9XG4gICAgICAgICAgICB4MSArIGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCAtIDE7XG4gICAgICAgIGNvbnN0IHkyID1cbiAgICAgICAgICAgIHkxICsgZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmhlaWdodCAtIDE7XG5cbiAgICAgICAgY29uc3QgZWxlbWVudHMxID0gdGhpcy5ET01TZXJ2aWNlLmdldE5hdGl2ZURvY3VtZW50KCkuZWxlbWVudHNGcm9tUG9pbnQoXG4gICAgICAgICAgICB4MSxcbiAgICAgICAgICAgIHkxXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGVsZW1lbnRzMiA9IHRoaXMuRE9NU2VydmljZS5nZXROYXRpdmVEb2N1bWVudCgpLmVsZW1lbnRzRnJvbVBvaW50KFxuICAgICAgICAgICAgeDIsXG4gICAgICAgICAgICB5MlxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChlbGVtZW50czEubGVuZ3RoID09PSAwICYmIGVsZW1lbnRzMi5sZW5ndGggPT09IDApIHJldHVybiAxO1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICB0aGlzLmdldEZpcnN0RWxlbWVudFdpdGhvdXRLZXl3b3JkKGVsZW1lbnRzMSwga2V5d29yZFRvRGlzY2FyZCkgIT09XG4gICAgICAgICAgICAgICAgZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50IHx8XG4gICAgICAgICAgICB0aGlzLmdldEZpcnN0RWxlbWVudFdpdGhvdXRLZXl3b3JkKGVsZW1lbnRzMiwga2V5d29yZFRvRGlzY2FyZCkgIT09XG4gICAgICAgICAgICAgICAgZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50XG4gICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuIDI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIDM7XG4gICAgfVxuXG4gICAgc2Nyb2xsSW50b1ZpZXcoZWxlbWVudFJlZjogRWxlbWVudFJlZiwgaXNFbGVtZW50Rml4ZWQ6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZmlyc3RTY3JvbGxhYmxlUGFyZW50ID0gdGhpcy5nZXRGaXJzdFNjcm9sbGFibGVQYXJlbnQoXG4gICAgICAgICAgICBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnRcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgdG9wID0gaXNFbGVtZW50Rml4ZWRcbiAgICAgICAgICAgID8gdGhpcy5nZXRFbGVtZW50Rml4ZWRUb3AoZWxlbWVudFJlZilcbiAgICAgICAgICAgIDogdGhpcy5nZXRFbGVtZW50QWJzb2x1dGVUb3AoZWxlbWVudFJlZik7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIGZpcnN0U2Nyb2xsYWJsZVBhcmVudCAhPT0gdGhpcy5ET01TZXJ2aWNlLmdldE5hdGl2ZURvY3VtZW50KCkuYm9keVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGlmIChmaXJzdFNjcm9sbGFibGVQYXJlbnQuc2Nyb2xsVG8pIHtcbiAgICAgICAgICAgICAgICBmaXJzdFNjcm9sbGFibGVQYXJlbnQuc2Nyb2xsVG8oMCwgdG9wIC0gMTUwKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gSUUgMTEgLSBFZGdlIGJyb3dzZXJzXG4gICAgICAgICAgICAgICAgZmlyc3RTY3JvbGxhYmxlUGFyZW50LnNjcm9sbFRvcCA9IHRvcCAtIDE1MDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuRE9NU2VydmljZS5nZXROYXRpdmVXaW5kb3coKS5zY3JvbGxUbygwLCB0b3AgLSAxNTApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2Nyb2xsVG9UaGVUb3AoZWxlbWVudFJlZjogRWxlbWVudFJlZik6IHZvaWQge1xuICAgICAgICBjb25zdCBmaXJzdFNjcm9sbGFibGVQYXJlbnQgPSB0aGlzLmdldEZpcnN0U2Nyb2xsYWJsZVBhcmVudChcbiAgICAgICAgICAgIGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudFxuICAgICAgICApO1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICBmaXJzdFNjcm9sbGFibGVQYXJlbnQgIT09IHRoaXMuRE9NU2VydmljZS5nZXROYXRpdmVEb2N1bWVudCgpLmJvZHlcbiAgICAgICAgKSB7XG4gICAgICAgICAgICBpZiAoZmlyc3RTY3JvbGxhYmxlUGFyZW50LnNjcm9sbFRvKSB7XG4gICAgICAgICAgICAgICAgZmlyc3RTY3JvbGxhYmxlUGFyZW50LnNjcm9sbFRvKDAsIDApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBJRSAxMSAtIEVkZ2UgYnJvd3NlcnNcbiAgICAgICAgICAgICAgICBmaXJzdFNjcm9sbGFibGVQYXJlbnQuc2Nyb2xsVG9wID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuRE9NU2VydmljZS5nZXROYXRpdmVXaW5kb3coKS5zY3JvbGxUbygwLCAwKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNjcm9sbFRvVGhlQm90dG9tKGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZmlyc3RTY3JvbGxhYmxlUGFyZW50ID0gdGhpcy5nZXRGaXJzdFNjcm9sbGFibGVQYXJlbnQoXG4gICAgICAgICAgICBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnRcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgZmlyc3RTY3JvbGxhYmxlUGFyZW50ICE9PSB0aGlzLkRPTVNlcnZpY2UuZ2V0TmF0aXZlRG9jdW1lbnQoKS5ib2R5XG4gICAgICAgICkge1xuICAgICAgICAgICAgaWYgKGZpcnN0U2Nyb2xsYWJsZVBhcmVudC5zY3JvbGxUbykge1xuICAgICAgICAgICAgICAgIGZpcnN0U2Nyb2xsYWJsZVBhcmVudC5zY3JvbGxUbyhcbiAgICAgICAgICAgICAgICAgICAgMCxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ET01TZXJ2aWNlLmdldE5hdGl2ZURvY3VtZW50KCkuYm9keS5zY3JvbGxIZWlnaHRcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBJRSAxMSAtIEVkZ2UgYnJvd3NlcnNcbiAgICAgICAgICAgICAgICBmaXJzdFNjcm9sbGFibGVQYXJlbnQuc2Nyb2xsVG9wID1cbiAgICAgICAgICAgICAgICAgICAgZmlyc3RTY3JvbGxhYmxlUGFyZW50LnNjcm9sbEhlaWdodCAtXG4gICAgICAgICAgICAgICAgICAgIGZpcnN0U2Nyb2xsYWJsZVBhcmVudC5jbGllbnRIZWlnaHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLkRPTVNlcnZpY2UuZ2V0TmF0aXZlV2luZG93KCkuc2Nyb2xsVG8oXG4gICAgICAgICAgICAgICAgMCxcbiAgICAgICAgICAgICAgICB0aGlzLkRPTVNlcnZpY2UuZ2V0TmF0aXZlRG9jdW1lbnQoKS5ib2R5LnNjcm9sbEhlaWdodFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Rmlyc3RTY3JvbGxhYmxlUGFyZW50KG5vZGU6IGFueSkge1xuICAgICAgICBjb25zdCByZWdleCA9IC8oYXV0b3xzY3JvbGx8b3ZlcmxheSkvO1xuXG4gICAgICAgIGNvbnN0IHN0eWxlID0gKG5vZGU6IGFueSwgcHJvcDogYW55KSA9PlxuICAgICAgICAgICAgdGhpcy5ET01TZXJ2aWNlLmdldE5hdGl2ZVdpbmRvdygpXG4gICAgICAgICAgICAgICAgLmdldENvbXB1dGVkU3R5bGUobm9kZSwgbnVsbClcbiAgICAgICAgICAgICAgICAuZ2V0UHJvcGVydHlWYWx1ZShwcm9wKTtcblxuICAgICAgICBjb25zdCBzY3JvbGwgPSAobm9kZTogYW55KSA9PlxuICAgICAgICAgICAgcmVnZXgudGVzdChcbiAgICAgICAgICAgICAgICBzdHlsZShub2RlLCAnb3ZlcmZsb3cnKSArXG4gICAgICAgICAgICAgICAgICAgIHN0eWxlKG5vZGUsICdvdmVyZmxvdy15JykgK1xuICAgICAgICAgICAgICAgICAgICBzdHlsZShub2RlLCAnb3ZlcmZsb3cteCcpXG4gICAgICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IHNjcm9sbHBhcmVudCA9IChub2RlOiBhbnkpOiBhbnkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuICFub2RlIHx8IG5vZGUgPT09IHRoaXMuRE9NU2VydmljZS5nZXROYXRpdmVEb2N1bWVudCgpLmJvZHlcbiAgICAgICAgICAgICAgICA/IHRoaXMuRE9NU2VydmljZS5nZXROYXRpdmVEb2N1bWVudCgpLmJvZHlcbiAgICAgICAgICAgICAgICA6IHNjcm9sbChub2RlKVxuICAgICAgICAgICAgICAgID8gbm9kZVxuICAgICAgICAgICAgICAgIDogc2Nyb2xscGFyZW50KG5vZGUucGFyZW50Tm9kZSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIHNjcm9sbHBhcmVudChub2RlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGN1bGF0ZURvY3VtZW50SGVpZ2h0KCkge1xuICAgICAgICBjb25zdCBkb2N1bWVudFJlZiA9IHRoaXMuRE9NU2VydmljZS5nZXROYXRpdmVEb2N1bWVudCgpO1xuICAgICAgICByZXR1cm4gTWF0aC5tYXgoXG4gICAgICAgICAgICBkb2N1bWVudFJlZi5ib2R5LnNjcm9sbEhlaWdodCxcbiAgICAgICAgICAgIGRvY3VtZW50UmVmLmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQsXG4gICAgICAgICAgICBkb2N1bWVudFJlZi5ib2R5Lm9mZnNldEhlaWdodCxcbiAgICAgICAgICAgIGRvY3VtZW50UmVmLmRvY3VtZW50RWxlbWVudC5vZmZzZXRIZWlnaHQsXG4gICAgICAgICAgICBkb2N1bWVudFJlZi5ib2R5LmNsaWVudEhlaWdodCxcbiAgICAgICAgICAgIGRvY3VtZW50UmVmLmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHRcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFNjcm9sbE9mZnNldHMoKSB7XG4gICAgICAgIGNvbnN0IHdpblJlZmVyZW5jZSA9IHRoaXMuRE9NU2VydmljZS5nZXROYXRpdmVXaW5kb3coKTtcbiAgICAgICAgY29uc3QgZG9jUmVmZXJlbmNlID0gdGhpcy5ET01TZXJ2aWNlLmdldE5hdGl2ZURvY3VtZW50KCk7XG5cbiAgICAgICAgLy8gVGhpcyB3b3JrcyBmb3IgYWxsIGJyb3dzZXJzIGV4Y2VwdCBJRSB2ZXJzaW9ucyA4IGFuZCBiZWZvcmVcbiAgICAgICAgaWYgKHdpblJlZmVyZW5jZS5wYWdlWE9mZnNldCAhPSBudWxsKVxuICAgICAgICAgICAgcmV0dXJuIHsgeDogd2luUmVmZXJlbmNlLnBhZ2VYT2Zmc2V0LCB5OiB3aW5SZWZlcmVuY2UucGFnZVlPZmZzZXQgfTtcblxuICAgICAgICAvLyBGb3IgSUUgKG9yIGFueSBicm93c2VyKSBpbiBTdGFuZGFyZHMgbW9kZVxuICAgICAgICBpZiAoZG9jUmVmZXJlbmNlLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKVxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB4OiBkb2NSZWZlcmVuY2UuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQsXG4gICAgICAgICAgICAgICAgeTogZG9jUmVmZXJlbmNlLmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3BcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgLy8gRm9yIGJyb3dzZXJzIGluIFF1aXJrcyBtb2RlXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB4OiBkb2NSZWZlcmVuY2UuYm9keS5zY3JvbGxMZWZ0LFxuICAgICAgICAgICAgeTogZG9jUmVmZXJlbmNlLmJvZHkuc2Nyb2xsVG9wXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBlbGVtZW50c0Zyb21Qb2ludCh4LCB5KSB7XG4gICAgICAgIHZhciBwYXJlbnRzID0gW107XG4gICAgICAgIHZhciBwYXJlbnQgPSB2b2lkIDA7XG4gICAgICAgIGRvIHtcbiAgICAgICAgICAgIGNvbnN0IGVsZW0gPSB0aGlzLkRPTVNlcnZpY2UuZ2V0TmF0aXZlRG9jdW1lbnQoKS5lbGVtZW50RnJvbVBvaW50KFxuICAgICAgICAgICAgICAgIHgsXG4gICAgICAgICAgICAgICAgeVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmIChlbGVtICYmIHBhcmVudCAhPT0gZWxlbSkge1xuICAgICAgICAgICAgICAgIHBhcmVudCA9IGVsZW07XG4gICAgICAgICAgICAgICAgcGFyZW50cy5wdXNoKHBhcmVudCk7XG4gICAgICAgICAgICAgICAgcGFyZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnbm9uZSc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBhcmVudCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IHdoaWxlIChwYXJlbnQpO1xuICAgICAgICBwYXJlbnRzLmZvckVhY2goZnVuY3Rpb24ocGFyZW50KSB7XG4gICAgICAgICAgICByZXR1cm4gKHBhcmVudC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ2FsbCcpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHBhcmVudHM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRGaXJzdEVsZW1lbnRXaXRob3V0S2V5d29yZChcbiAgICAgICAgZWxlbWVudHM6IEVsZW1lbnRbXSxcbiAgICAgICAga2V5d29yZDogc3RyaW5nXG4gICAgKTogRWxlbWVudCB7XG4gICAgICAgIHdoaWxlIChcbiAgICAgICAgICAgIGVsZW1lbnRzWzBdICYmXG4gICAgICAgICAgICBlbGVtZW50c1swXS5jbGFzc0xpc3QudG9TdHJpbmcoKS5pbmNsdWRlcyhrZXl3b3JkKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGVsZW1lbnRzLnNoaWZ0KCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVsZW1lbnRzWzBdO1xuICAgIH1cbn1cbiJdfQ==
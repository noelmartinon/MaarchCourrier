import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { JoyrideOptionsService } from './joyride-options.service';
import { LoggerService } from './logger.service';
import { JoyrideError, JoyrideStepOutOfRange } from '../models/joyride-error.class';
var ROUTE_SEPARATOR = '@';
var Step = /** @class */ (function () {
    function Step() {
    }
    return Step;
}());
export var StepActionType;
(function (StepActionType) {
    StepActionType["NEXT"] = "NEXT";
    StepActionType["PREV"] = "PREV";
})(StepActionType || (StepActionType = {}));
var JoyrideStepsContainerService = /** @class */ (function () {
    function JoyrideStepsContainerService(stepOptions, logger) {
        this.stepOptions = stepOptions;
        this.logger = logger;
        this.tempSteps = [];
        this.currentStepIndex = -2;
        this.stepHasBeenModified = new Subject();
    }
    JoyrideStepsContainerService.prototype.getFirstStepIndex = function () {
        var firstStep = this.stepOptions.getFirstStep();
        var stepIds = this.stepOptions.getStepsOrder();
        var index = stepIds.indexOf(firstStep);
        if (index < 0) {
            index = 0;
            if (firstStep !== undefined)
                this.logger.warn("The step " + firstStep + " does not exist. Check in your step list if it's present.");
        }
        return index;
    };
    JoyrideStepsContainerService.prototype.init = function () {
        var _this = this;
        this.logger.info('Initializing the steps array.');
        this.steps = [];
        this.currentStepIndex = this.getFirstStepIndex() - 1;
        var stepIds = this.stepOptions.getStepsOrder();
        stepIds.forEach(function (stepId) { return _this.steps.push({ id: stepId, step: null }); });
    };
    JoyrideStepsContainerService.prototype.addStep = function (stepToAdd) {
        var stepExist = this.tempSteps.filter(function (step) { return step.name === stepToAdd.name; }).length > 0;
        if (!stepExist) {
            this.logger.info("Adding step " + stepToAdd.name + " to the steps list.");
            this.tempSteps.push(stepToAdd);
        }
        else {
            var stepIndexToReplace = this.tempSteps.findIndex(function (step) { return step.name === stepToAdd.name; });
            this.tempSteps[stepIndexToReplace] = stepToAdd;
        }
    };
    JoyrideStepsContainerService.prototype.get = function (action) {
        if (action === StepActionType.NEXT)
            this.currentStepIndex++;
        else
            this.currentStepIndex--;
        if (this.currentStepIndex < 0 || this.currentStepIndex >= this.steps.length)
            throw new JoyrideStepOutOfRange('The first or last step of the tour cannot be found!');
        var stepName = this.getStepName(this.steps[this.currentStepIndex].id);
        var index = this.tempSteps.findIndex(function (step) { return step.name === stepName; });
        var stepFound = this.tempSteps[index];
        this.steps[this.currentStepIndex].step = stepFound;
        if (stepFound == null) {
            this.logger.warn("Step " + this.steps[this.currentStepIndex].id + " not found in the DOM. Check if it's hidden by *ngIf directive.");
        }
        return stepFound;
    };
    JoyrideStepsContainerService.prototype.getStepRoute = function (action) {
        var stepID;
        if (action === StepActionType.NEXT) {
            stepID = this.steps[this.currentStepIndex + 1] ? this.steps[this.currentStepIndex + 1].id : null;
        }
        else {
            stepID = this.steps[this.currentStepIndex - 1] ? this.steps[this.currentStepIndex - 1].id : null;
        }
        var stepRoute = stepID && stepID.includes(ROUTE_SEPARATOR) ? stepID.split(ROUTE_SEPARATOR)[1] : '';
        return stepRoute;
    };
    JoyrideStepsContainerService.prototype.updatePosition = function (stepName, position) {
        var index = this.getStepIndex(stepName);
        if (this.steps[index].step) {
            this.steps[index].step.position = position;
            this.stepHasBeenModified.next(this.steps[index].step);
        }
        else {
            this.logger.warn("Trying to modify the position of " + stepName + " to " + position + ". Step not found!Is this step located in a different route?");
        }
    };
    JoyrideStepsContainerService.prototype.getStepNumber = function (stepName) {
        return this.getStepIndex(stepName) + 1;
    };
    JoyrideStepsContainerService.prototype.getStepsCount = function () {
        var stepsOrder = this.stepOptions.getStepsOrder();
        return stepsOrder.length;
    };
    JoyrideStepsContainerService.prototype.getStepIndex = function (stepName) {
        var index = this.steps
            .map(function (step) { return (step.id.includes(ROUTE_SEPARATOR) ? step.id.split(ROUTE_SEPARATOR)[0] : step.id); })
            .findIndex(function (name) { return stepName === name; });
        if (index === -1)
            throw new JoyrideError("The step with name: " + stepName + " does not exist in the step list.");
        return index;
    };
    JoyrideStepsContainerService.prototype.getStepName = function (stepID) {
        var stepName = stepID && stepID.includes(ROUTE_SEPARATOR) ? stepID.split(ROUTE_SEPARATOR)[0] : stepID;
        return stepName;
    };
    JoyrideStepsContainerService.ctorParameters = function () { return [
        { type: JoyrideOptionsService },
        { type: LoggerService }
    ]; };
    JoyrideStepsContainerService = __decorate([
        Injectable()
    ], JoyrideStepsContainerService);
    return JoyrideStepsContainerService;
}());
export { JoyrideStepsContainerService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiam95cmlkZS1zdGVwcy1jb250YWluZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1qb3lyaWRlLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2pveXJpZGUtc3RlcHMtY29udGFpbmVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLFlBQVksRUFBRSxxQkFBcUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBRXBGLElBQU0sZUFBZSxHQUFHLEdBQUcsQ0FBQztBQUU1QjtJQUFBO0lBR0EsQ0FBQztJQUFELFdBQUM7QUFBRCxDQUFDLEFBSEQsSUFHQztBQUVELE1BQU0sQ0FBTixJQUFZLGNBR1g7QUFIRCxXQUFZLGNBQWM7SUFDdEIsK0JBQWEsQ0FBQTtJQUNiLCtCQUFhLENBQUE7QUFDakIsQ0FBQyxFQUhXLGNBQWMsS0FBZCxjQUFjLFFBR3pCO0FBR0Q7SUFNSSxzQ0FBNkIsV0FBa0MsRUFBbUIsTUFBcUI7UUFBMUUsZ0JBQVcsR0FBWCxXQUFXLENBQXVCO1FBQW1CLFdBQU0sR0FBTixNQUFNLENBQWU7UUFKL0YsY0FBUyxHQUFrQixFQUFFLENBQUM7UUFDOUIscUJBQWdCLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDOUIsd0JBQW1CLEdBQXlCLElBQUksT0FBTyxFQUFlLENBQUM7SUFFbUMsQ0FBQztJQUVuRyx3REFBaUIsR0FBekI7UUFDSSxJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ2xELElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFakQsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN2QyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUU7WUFDWCxLQUFLLEdBQUcsQ0FBQyxDQUFDO1lBQ1YsSUFBSSxTQUFTLEtBQUssU0FBUztnQkFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFZLFNBQVMsOERBQTJELENBQUMsQ0FBQztTQUNuSTtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFRCwyQ0FBSSxHQUFKO1FBQUEsaUJBTUM7UUFMRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDckQsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUMvQyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQUEsTUFBTSxJQUFJLE9BQUEsS0FBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUEzQyxDQUEyQyxDQUFDLENBQUM7SUFDM0UsQ0FBQztJQUVELDhDQUFPLEdBQVAsVUFBUSxTQUFzQjtRQUMxQixJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLElBQUksRUFBNUIsQ0FBNEIsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDdkYsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNaLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFlLFNBQVMsQ0FBQyxJQUFJLHdCQUFxQixDQUFDLENBQUM7WUFDckUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDbEM7YUFBTTtZQUNILElBQUksa0JBQWtCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxJQUFJLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxJQUFJLEVBQTVCLENBQTRCLENBQUMsQ0FBQztZQUN4RixJQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsU0FBUyxDQUFDO1NBQ2xEO0lBQ0wsQ0FBQztJQUNELDBDQUFHLEdBQUgsVUFBSSxNQUFzQjtRQUN0QixJQUFJLE1BQU0sS0FBSyxjQUFjLENBQUMsSUFBSTtZQUFFLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDOztZQUN2RCxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUU3QixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTTtZQUN2RSxNQUFNLElBQUkscUJBQXFCLENBQUMscURBQXFELENBQUMsQ0FBQztRQUUzRixJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDeEUsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxJQUFJLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBdEIsQ0FBc0IsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDO1FBRW5ELElBQUksU0FBUyxJQUFJLElBQUksRUFBRTtZQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFRLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBRSxvRUFBaUUsQ0FBQyxDQUFDO1NBQ25JO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQztJQUVELG1EQUFZLEdBQVosVUFBYSxNQUFzQjtRQUMvQixJQUFJLE1BQWMsQ0FBQztRQUNuQixJQUFJLE1BQU0sS0FBSyxjQUFjLENBQUMsSUFBSSxFQUFFO1lBQ2hDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7U0FDcEc7YUFBTTtZQUNILE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7U0FDcEc7UUFDRCxJQUFJLFNBQVMsR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBRW5HLE9BQU8sU0FBUyxDQUFDO0lBQ3JCLENBQUM7SUFFRCxxREFBYyxHQUFkLFVBQWUsUUFBZ0IsRUFBRSxRQUFnQjtRQUM3QyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3hDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLEVBQUU7WUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztZQUMzQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDekQ7YUFBTTtZQUNILElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNaLHNDQUFvQyxRQUFRLFlBQU8sUUFBUSxnRUFBNkQsQ0FDM0gsQ0FBQztTQUNMO0lBQ0wsQ0FBQztJQUNELG9EQUFhLEdBQWIsVUFBYyxRQUFnQjtRQUMxQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFFRCxvREFBYSxHQUFiO1FBQ0ksSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNsRCxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUM7SUFDN0IsQ0FBQztJQUVPLG1EQUFZLEdBQXBCLFVBQXFCLFFBQWdCO1FBQ2pDLElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLO2FBQ25CLEdBQUcsQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQWpGLENBQWlGLENBQUM7YUFDOUYsU0FBUyxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsUUFBUSxLQUFLLElBQUksRUFBakIsQ0FBaUIsQ0FBQyxDQUFDO1FBQzFDLElBQUksS0FBSyxLQUFLLENBQUMsQ0FBQztZQUFFLE1BQU0sSUFBSSxZQUFZLENBQUMseUJBQXVCLFFBQVEsc0NBQW1DLENBQUMsQ0FBQztRQUM3RyxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRU8sa0RBQVcsR0FBbkIsVUFBb0IsTUFBYztRQUM5QixJQUFJLFFBQVEsR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ3RHLE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7O2dCQS9GeUMscUJBQXFCO2dCQUEyQixhQUFhOztJQU45Riw0QkFBNEI7UUFEeEMsVUFBVSxFQUFFO09BQ0EsNEJBQTRCLENBc0d4QztJQUFELG1DQUFDO0NBQUEsQUF0R0QsSUFzR0M7U0F0R1ksNEJBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSm95cmlkZVN0ZXAgfSBmcm9tICcuLi9tb2RlbHMvam95cmlkZS1zdGVwLmNsYXNzJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEpveXJpZGVPcHRpb25zU2VydmljZSB9IGZyb20gJy4vam95cmlkZS1vcHRpb25zLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9nZ2VyU2VydmljZSB9IGZyb20gJy4vbG9nZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgSm95cmlkZUVycm9yLCBKb3lyaWRlU3RlcE91dE9mUmFuZ2UgfSBmcm9tICcuLi9tb2RlbHMvam95cmlkZS1lcnJvci5jbGFzcyc7XG5cbmNvbnN0IFJPVVRFX1NFUEFSQVRPUiA9ICdAJztcblxuY2xhc3MgU3RlcCB7XG4gICAgaWQ6IHN0cmluZztcbiAgICBzdGVwOiBKb3lyaWRlU3RlcDtcbn1cblxuZXhwb3J0IGVudW0gU3RlcEFjdGlvblR5cGUge1xuICAgIE5FWFQgPSAnTkVYVCcsXG4gICAgUFJFViA9ICdQUkVWJ1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgSm95cmlkZVN0ZXBzQ29udGFpbmVyU2VydmljZSB7XG4gICAgcHJpdmF0ZSBzdGVwczogU3RlcFtdO1xuICAgIHByaXZhdGUgdGVtcFN0ZXBzOiBKb3lyaWRlU3RlcFtdID0gW107XG4gICAgcHJpdmF0ZSBjdXJyZW50U3RlcEluZGV4ID0gLTI7XG4gICAgc3RlcEhhc0JlZW5Nb2RpZmllZDogU3ViamVjdDxKb3lyaWRlU3RlcD4gPSBuZXcgU3ViamVjdDxKb3lyaWRlU3RlcD4oKTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgc3RlcE9wdGlvbnM6IEpveXJpZGVPcHRpb25zU2VydmljZSwgcHJpdmF0ZSByZWFkb25seSBsb2dnZXI6IExvZ2dlclNlcnZpY2UpIHt9XG5cbiAgICBwcml2YXRlIGdldEZpcnN0U3RlcEluZGV4KCk6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IGZpcnN0U3RlcCA9IHRoaXMuc3RlcE9wdGlvbnMuZ2V0Rmlyc3RTdGVwKCk7XG4gICAgICAgIGNvbnN0IHN0ZXBJZHMgPSB0aGlzLnN0ZXBPcHRpb25zLmdldFN0ZXBzT3JkZXIoKTtcblxuICAgICAgICBsZXQgaW5kZXggPSBzdGVwSWRzLmluZGV4T2YoZmlyc3RTdGVwKTtcbiAgICAgICAgaWYgKGluZGV4IDwgMCkge1xuICAgICAgICAgICAgaW5kZXggPSAwO1xuICAgICAgICAgICAgaWYgKGZpcnN0U3RlcCAhPT0gdW5kZWZpbmVkKSB0aGlzLmxvZ2dlci53YXJuKGBUaGUgc3RlcCAke2ZpcnN0U3RlcH0gZG9lcyBub3QgZXhpc3QuIENoZWNrIGluIHlvdXIgc3RlcCBsaXN0IGlmIGl0J3MgcHJlc2VudC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBpbmRleDtcbiAgICB9XG5cbiAgICBpbml0KCkge1xuICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKCdJbml0aWFsaXppbmcgdGhlIHN0ZXBzIGFycmF5LicpO1xuICAgICAgICB0aGlzLnN0ZXBzID0gW107XG4gICAgICAgIHRoaXMuY3VycmVudFN0ZXBJbmRleCA9IHRoaXMuZ2V0Rmlyc3RTdGVwSW5kZXgoKSAtIDE7XG4gICAgICAgIGxldCBzdGVwSWRzID0gdGhpcy5zdGVwT3B0aW9ucy5nZXRTdGVwc09yZGVyKCk7XG4gICAgICAgIHN0ZXBJZHMuZm9yRWFjaChzdGVwSWQgPT4gdGhpcy5zdGVwcy5wdXNoKHsgaWQ6IHN0ZXBJZCwgc3RlcDogbnVsbCB9KSk7XG4gICAgfVxuXG4gICAgYWRkU3RlcChzdGVwVG9BZGQ6IEpveXJpZGVTdGVwKSB7XG4gICAgICAgIGxldCBzdGVwRXhpc3QgPSB0aGlzLnRlbXBTdGVwcy5maWx0ZXIoc3RlcCA9PiBzdGVwLm5hbWUgPT09IHN0ZXBUb0FkZC5uYW1lKS5sZW5ndGggPiAwO1xuICAgICAgICBpZiAoIXN0ZXBFeGlzdCkge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIuaW5mbyhgQWRkaW5nIHN0ZXAgJHtzdGVwVG9BZGQubmFtZX0gdG8gdGhlIHN0ZXBzIGxpc3QuYCk7XG4gICAgICAgICAgICB0aGlzLnRlbXBTdGVwcy5wdXNoKHN0ZXBUb0FkZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgc3RlcEluZGV4VG9SZXBsYWNlID0gdGhpcy50ZW1wU3RlcHMuZmluZEluZGV4KHN0ZXAgPT4gc3RlcC5uYW1lID09PSBzdGVwVG9BZGQubmFtZSk7XG4gICAgICAgICAgICB0aGlzLnRlbXBTdGVwc1tzdGVwSW5kZXhUb1JlcGxhY2VdID0gc3RlcFRvQWRkO1xuICAgICAgICB9XG4gICAgfVxuICAgIGdldChhY3Rpb246IFN0ZXBBY3Rpb25UeXBlKTogSm95cmlkZVN0ZXAge1xuICAgICAgICBpZiAoYWN0aW9uID09PSBTdGVwQWN0aW9uVHlwZS5ORVhUKSB0aGlzLmN1cnJlbnRTdGVwSW5kZXgrKztcbiAgICAgICAgZWxzZSB0aGlzLmN1cnJlbnRTdGVwSW5kZXgtLTtcblxuICAgICAgICBpZiAodGhpcy5jdXJyZW50U3RlcEluZGV4IDwgMCB8fCB0aGlzLmN1cnJlbnRTdGVwSW5kZXggPj0gdGhpcy5zdGVwcy5sZW5ndGgpXG4gICAgICAgICAgICB0aHJvdyBuZXcgSm95cmlkZVN0ZXBPdXRPZlJhbmdlKCdUaGUgZmlyc3Qgb3IgbGFzdCBzdGVwIG9mIHRoZSB0b3VyIGNhbm5vdCBiZSBmb3VuZCEnKTtcblxuICAgICAgICBjb25zdCBzdGVwTmFtZSA9IHRoaXMuZ2V0U3RlcE5hbWUodGhpcy5zdGVwc1t0aGlzLmN1cnJlbnRTdGVwSW5kZXhdLmlkKTtcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnRlbXBTdGVwcy5maW5kSW5kZXgoc3RlcCA9PiBzdGVwLm5hbWUgPT09IHN0ZXBOYW1lKTtcbiAgICAgICAgbGV0IHN0ZXBGb3VuZCA9IHRoaXMudGVtcFN0ZXBzW2luZGV4XTtcbiAgICAgICAgdGhpcy5zdGVwc1t0aGlzLmN1cnJlbnRTdGVwSW5kZXhdLnN0ZXAgPSBzdGVwRm91bmQ7XG5cbiAgICAgICAgaWYgKHN0ZXBGb3VuZCA9PSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKGBTdGVwICR7dGhpcy5zdGVwc1t0aGlzLmN1cnJlbnRTdGVwSW5kZXhdLmlkfSBub3QgZm91bmQgaW4gdGhlIERPTS4gQ2hlY2sgaWYgaXQncyBoaWRkZW4gYnkgKm5nSWYgZGlyZWN0aXZlLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHN0ZXBGb3VuZDtcbiAgICB9XG5cbiAgICBnZXRTdGVwUm91dGUoYWN0aW9uOiBTdGVwQWN0aW9uVHlwZSkge1xuICAgICAgICBsZXQgc3RlcElEOiBzdHJpbmc7XG4gICAgICAgIGlmIChhY3Rpb24gPT09IFN0ZXBBY3Rpb25UeXBlLk5FWFQpIHtcbiAgICAgICAgICAgIHN0ZXBJRCA9IHRoaXMuc3RlcHNbdGhpcy5jdXJyZW50U3RlcEluZGV4ICsgMV0gPyB0aGlzLnN0ZXBzW3RoaXMuY3VycmVudFN0ZXBJbmRleCArIDFdLmlkIDogbnVsbDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0ZXBJRCA9IHRoaXMuc3RlcHNbdGhpcy5jdXJyZW50U3RlcEluZGV4IC0gMV0gPyB0aGlzLnN0ZXBzW3RoaXMuY3VycmVudFN0ZXBJbmRleCAtIDFdLmlkIDogbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBsZXQgc3RlcFJvdXRlID0gc3RlcElEICYmIHN0ZXBJRC5pbmNsdWRlcyhST1VURV9TRVBBUkFUT1IpID8gc3RlcElELnNwbGl0KFJPVVRFX1NFUEFSQVRPUilbMV0gOiAnJztcblxuICAgICAgICByZXR1cm4gc3RlcFJvdXRlO1xuICAgIH1cblxuICAgIHVwZGF0ZVBvc2l0aW9uKHN0ZXBOYW1lOiBzdHJpbmcsIHBvc2l0aW9uOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGluZGV4ID0gdGhpcy5nZXRTdGVwSW5kZXgoc3RlcE5hbWUpO1xuICAgICAgICBpZiAodGhpcy5zdGVwc1tpbmRleF0uc3RlcCkge1xuICAgICAgICAgICAgdGhpcy5zdGVwc1tpbmRleF0uc3RlcC5wb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgICAgICAgICAgdGhpcy5zdGVwSGFzQmVlbk1vZGlmaWVkLm5leHQodGhpcy5zdGVwc1tpbmRleF0uc3RlcCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKFxuICAgICAgICAgICAgICAgIGBUcnlpbmcgdG8gbW9kaWZ5IHRoZSBwb3NpdGlvbiBvZiAke3N0ZXBOYW1lfSB0byAke3Bvc2l0aW9ufS4gU3RlcCBub3QgZm91bmQhSXMgdGhpcyBzdGVwIGxvY2F0ZWQgaW4gYSBkaWZmZXJlbnQgcm91dGU/YFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBnZXRTdGVwTnVtYmVyKHN0ZXBOYW1lOiBzdHJpbmcpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRTdGVwSW5kZXgoc3RlcE5hbWUpICsgMTtcbiAgICB9XG5cbiAgICBnZXRTdGVwc0NvdW50KCkge1xuICAgICAgICBsZXQgc3RlcHNPcmRlciA9IHRoaXMuc3RlcE9wdGlvbnMuZ2V0U3RlcHNPcmRlcigpO1xuICAgICAgICByZXR1cm4gc3RlcHNPcmRlci5sZW5ndGg7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRTdGVwSW5kZXgoc3RlcE5hbWU6IHN0cmluZyk6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zdGVwc1xuICAgICAgICAgICAgLm1hcChzdGVwID0+IChzdGVwLmlkLmluY2x1ZGVzKFJPVVRFX1NFUEFSQVRPUikgPyBzdGVwLmlkLnNwbGl0KFJPVVRFX1NFUEFSQVRPUilbMF0gOiBzdGVwLmlkKSlcbiAgICAgICAgICAgIC5maW5kSW5kZXgobmFtZSA9PiBzdGVwTmFtZSA9PT0gbmFtZSk7XG4gICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHRocm93IG5ldyBKb3lyaWRlRXJyb3IoYFRoZSBzdGVwIHdpdGggbmFtZTogJHtzdGVwTmFtZX0gZG9lcyBub3QgZXhpc3QgaW4gdGhlIHN0ZXAgbGlzdC5gKTtcbiAgICAgICAgcmV0dXJuIGluZGV4O1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0U3RlcE5hbWUoc3RlcElEOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBsZXQgc3RlcE5hbWUgPSBzdGVwSUQgJiYgc3RlcElELmluY2x1ZGVzKFJPVVRFX1NFUEFSQVRPUikgPyBzdGVwSUQuc3BsaXQoUk9VVEVfU0VQQVJBVE9SKVswXSA6IHN0ZXBJRDtcbiAgICAgICAgcmV0dXJuIHN0ZXBOYW1lO1xuICAgIH1cbn1cbiJdfQ==
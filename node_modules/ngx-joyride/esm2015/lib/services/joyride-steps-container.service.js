import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { JoyrideOptionsService } from './joyride-options.service';
import { LoggerService } from './logger.service';
import { JoyrideError, JoyrideStepOutOfRange } from '../models/joyride-error.class';
const ROUTE_SEPARATOR = '@';
class Step {
}
export var StepActionType;
(function (StepActionType) {
    StepActionType["NEXT"] = "NEXT";
    StepActionType["PREV"] = "PREV";
})(StepActionType || (StepActionType = {}));
let JoyrideStepsContainerService = class JoyrideStepsContainerService {
    constructor(stepOptions, logger) {
        this.stepOptions = stepOptions;
        this.logger = logger;
        this.tempSteps = [];
        this.currentStepIndex = -2;
        this.stepHasBeenModified = new Subject();
    }
    getFirstStepIndex() {
        const firstStep = this.stepOptions.getFirstStep();
        const stepIds = this.stepOptions.getStepsOrder();
        let index = stepIds.indexOf(firstStep);
        if (index < 0) {
            index = 0;
            if (firstStep !== undefined)
                this.logger.warn(`The step ${firstStep} does not exist. Check in your step list if it's present.`);
        }
        return index;
    }
    init() {
        this.logger.info('Initializing the steps array.');
        this.steps = [];
        this.currentStepIndex = this.getFirstStepIndex() - 1;
        let stepIds = this.stepOptions.getStepsOrder();
        stepIds.forEach(stepId => this.steps.push({ id: stepId, step: null }));
    }
    addStep(stepToAdd) {
        let stepExist = this.tempSteps.filter(step => step.name === stepToAdd.name).length > 0;
        if (!stepExist) {
            this.logger.info(`Adding step ${stepToAdd.name} to the steps list.`);
            this.tempSteps.push(stepToAdd);
        }
        else {
            let stepIndexToReplace = this.tempSteps.findIndex(step => step.name === stepToAdd.name);
            this.tempSteps[stepIndexToReplace] = stepToAdd;
        }
    }
    get(action) {
        if (action === StepActionType.NEXT)
            this.currentStepIndex++;
        else
            this.currentStepIndex--;
        if (this.currentStepIndex < 0 || this.currentStepIndex >= this.steps.length)
            throw new JoyrideStepOutOfRange('The first or last step of the tour cannot be found!');
        const stepName = this.getStepName(this.steps[this.currentStepIndex].id);
        const index = this.tempSteps.findIndex(step => step.name === stepName);
        let stepFound = this.tempSteps[index];
        this.steps[this.currentStepIndex].step = stepFound;
        if (stepFound == null) {
            this.logger.warn(`Step ${this.steps[this.currentStepIndex].id} not found in the DOM. Check if it's hidden by *ngIf directive.`);
        }
        return stepFound;
    }
    getStepRoute(action) {
        let stepID;
        if (action === StepActionType.NEXT) {
            stepID = this.steps[this.currentStepIndex + 1] ? this.steps[this.currentStepIndex + 1].id : null;
        }
        else {
            stepID = this.steps[this.currentStepIndex - 1] ? this.steps[this.currentStepIndex - 1].id : null;
        }
        let stepRoute = stepID && stepID.includes(ROUTE_SEPARATOR) ? stepID.split(ROUTE_SEPARATOR)[1] : '';
        return stepRoute;
    }
    updatePosition(stepName, position) {
        let index = this.getStepIndex(stepName);
        if (this.steps[index].step) {
            this.steps[index].step.position = position;
            this.stepHasBeenModified.next(this.steps[index].step);
        }
        else {
            this.logger.warn(`Trying to modify the position of ${stepName} to ${position}. Step not found!Is this step located in a different route?`);
        }
    }
    getStepNumber(stepName) {
        return this.getStepIndex(stepName) + 1;
    }
    getStepsCount() {
        let stepsOrder = this.stepOptions.getStepsOrder();
        return stepsOrder.length;
    }
    getStepIndex(stepName) {
        const index = this.steps
            .map(step => (step.id.includes(ROUTE_SEPARATOR) ? step.id.split(ROUTE_SEPARATOR)[0] : step.id))
            .findIndex(name => stepName === name);
        if (index === -1)
            throw new JoyrideError(`The step with name: ${stepName} does not exist in the step list.`);
        return index;
    }
    getStepName(stepID) {
        let stepName = stepID && stepID.includes(ROUTE_SEPARATOR) ? stepID.split(ROUTE_SEPARATOR)[0] : stepID;
        return stepName;
    }
};
JoyrideStepsContainerService.ctorParameters = () => [
    { type: JoyrideOptionsService },
    { type: LoggerService }
];
JoyrideStepsContainerService = __decorate([
    Injectable()
], JoyrideStepsContainerService);
export { JoyrideStepsContainerService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiam95cmlkZS1zdGVwcy1jb250YWluZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1qb3lyaWRlLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2pveXJpZGUtc3RlcHMtY29udGFpbmVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLFlBQVksRUFBRSxxQkFBcUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBRXBGLE1BQU0sZUFBZSxHQUFHLEdBQUcsQ0FBQztBQUU1QixNQUFNLElBQUk7Q0FHVDtBQUVELE1BQU0sQ0FBTixJQUFZLGNBR1g7QUFIRCxXQUFZLGNBQWM7SUFDdEIsK0JBQWEsQ0FBQTtJQUNiLCtCQUFhLENBQUE7QUFDakIsQ0FBQyxFQUhXLGNBQWMsS0FBZCxjQUFjLFFBR3pCO0FBR0QsSUFBYSw0QkFBNEIsR0FBekMsTUFBYSw0QkFBNEI7SUFNckMsWUFBNkIsV0FBa0MsRUFBbUIsTUFBcUI7UUFBMUUsZ0JBQVcsR0FBWCxXQUFXLENBQXVCO1FBQW1CLFdBQU0sR0FBTixNQUFNLENBQWU7UUFKL0YsY0FBUyxHQUFrQixFQUFFLENBQUM7UUFDOUIscUJBQWdCLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDOUIsd0JBQW1CLEdBQXlCLElBQUksT0FBTyxFQUFlLENBQUM7SUFFbUMsQ0FBQztJQUVuRyxpQkFBaUI7UUFDckIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNsRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFD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QVEsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ3RHLE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7Q0FDSixDQUFBOztZQWhHNkMscUJBQXFCO1lBQTJCLGFBQWE7O0FBTjlGLDRCQUE0QjtJQUR4QyxVQUFVLEVBQUU7R0FDQSw0QkFBNEIsQ0FzR3hDO1NBdEdZLDRCQUE0QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEpveXJpZGVTdGVwIH0gZnJvbSAnLi4vbW9kZWxzL2pveXJpZGUtc3RlcC5jbGFzcyc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBKb3lyaWRlT3B0aW9uc1NlcnZpY2UgfSBmcm9tICcuL2pveXJpZGUtb3B0aW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IExvZ2dlclNlcnZpY2UgfSBmcm9tICcuL2xvZ2dlci5zZXJ2aWNlJztcbmltcG9ydCB7IEpveXJpZGVFcnJvciwgSm95cmlkZVN0ZXBPdXRPZlJhbmdlIH0gZnJvbSAnLi4vbW9kZWxzL2pveXJpZGUtZXJyb3IuY2xhc3MnO1xuXG5jb25zdCBST1VURV9TRVBBUkFUT1IgPSAnQCc7XG5cbmNsYXNzIFN0ZXAge1xuICAgIGlkOiBzdHJpbmc7XG4gICAgc3RlcDogSm95cmlkZVN0ZXA7XG59XG5cbmV4cG9ydCBlbnVtIFN0ZXBBY3Rpb25UeXBlIHtcbiAgICBORVhUID0gJ05FWFQnLFxuICAgIFBSRVYgPSAnUFJFVidcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEpveXJpZGVTdGVwc0NvbnRhaW5lclNlcnZpY2Uge1xuICAgIHByaXZhdGUgc3RlcHM6IFN0ZXBbXTtcbiAgICBwcml2YXRlIHRlbXBTdGVwczogSm95cmlkZVN0ZXBbXSA9IFtdO1xuICAgIHByaXZhdGUgY3VycmVudFN0ZXBJbmRleCA9IC0yO1xuICAgIHN0ZXBIYXNCZWVuTW9kaWZpZWQ6IFN1YmplY3Q8Sm95cmlkZVN0ZXA+ID0gbmV3IFN1YmplY3Q8Sm95cmlkZVN0ZXA+KCk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHN0ZXBPcHRpb25zOiBKb3lyaWRlT3B0aW9uc1NlcnZpY2UsIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyOiBMb2dnZXJTZXJ2aWNlKSB7fVxuXG4gICAgcHJpdmF0ZSBnZXRGaXJzdFN0ZXBJbmRleCgpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBmaXJzdFN0ZXAgPSB0aGlzLnN0ZXBPcHRpb25zLmdldEZpcnN0U3RlcCgpO1xuICAgICAgICBjb25zdCBzdGVwSWRzID0gdGhpcy5zdGVwT3B0aW9ucy5nZXRTdGVwc09yZGVyKCk7XG5cbiAgICAgICAgbGV0IGluZGV4ID0gc3RlcElkcy5pbmRleE9mKGZpcnN0U3RlcCk7XG4gICAgICAgIGlmIChpbmRleCA8IDApIHtcbiAgICAgICAgICAgIGluZGV4ID0gMDtcbiAgICAgICAgICAgIGlmIChmaXJzdFN0ZXAgIT09IHVuZGVmaW5lZCkgdGhpcy5sb2dnZXIud2FybihgVGhlIHN0ZXAgJHtmaXJzdFN0ZXB9IGRvZXMgbm90IGV4aXN0LiBDaGVjayBpbiB5b3VyIHN0ZXAgbGlzdCBpZiBpdCdzIHByZXNlbnQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaW5kZXg7XG4gICAgfVxuXG4gICAgaW5pdCgpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuaW5mbygnSW5pdGlhbGl6aW5nIHRoZSBzdGVwcyBhcnJheS4nKTtcbiAgICAgICAgdGhpcy5zdGVwcyA9IFtdO1xuICAgICAgICB0aGlzLmN1cnJlbnRTdGVwSW5kZXggPSB0aGlzLmdldEZpcnN0U3RlcEluZGV4KCkgLSAxO1xuICAgICAgICBsZXQgc3RlcElkcyA9IHRoaXMuc3RlcE9wdGlvbnMuZ2V0U3RlcHNPcmRlcigpO1xuICAgICAgICBzdGVwSWRzLmZvckVhY2goc3RlcElkID0+IHRoaXMuc3RlcHMucHVzaCh7IGlkOiBzdGVwSWQsIHN0ZXA6IG51bGwgfSkpO1xuICAgIH1cblxuICAgIGFkZFN0ZXAoc3RlcFRvQWRkOiBKb3lyaWRlU3RlcCkge1xuICAgICAgICBsZXQgc3RlcEV4aXN0ID0gdGhpcy50ZW1wU3RlcHMuZmlsdGVyKHN0ZXAgPT4gc3RlcC5uYW1lID09PSBzdGVwVG9BZGQubmFtZSkubGVuZ3RoID4gMDtcbiAgICAgICAgaWYgKCFzdGVwRXhpc3QpIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmluZm8oYEFkZGluZyBzdGVwICR7c3RlcFRvQWRkLm5hbWV9IHRvIHRoZSBzdGVwcyBsaXN0LmApO1xuICAgICAgICAgICAgdGhpcy50ZW1wU3RlcHMucHVzaChzdGVwVG9BZGQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IHN0ZXBJbmRleFRvUmVwbGFjZSA9IHRoaXMudGVtcFN0ZXBzLmZpbmRJbmRleChzdGVwID0+IHN0ZXAubmFtZSA9PT0gc3RlcFRvQWRkLm5hbWUpO1xuICAgICAgICAgICAgdGhpcy50ZW1wU3RlcHNbc3RlcEluZGV4VG9SZXBsYWNlXSA9IHN0ZXBUb0FkZDtcbiAgICAgICAgfVxuICAgIH1cbiAgICBnZXQoYWN0aW9uOiBTdGVwQWN0aW9uVHlwZSk6IEpveXJpZGVTdGVwIHtcbiAgICAgICAgaWYgKGFjdGlvbiA9PT0gU3RlcEFjdGlvblR5cGUuTkVYVCkgdGhpcy5jdXJyZW50U3RlcEluZGV4Kys7XG4gICAgICAgIGVsc2UgdGhpcy5jdXJyZW50U3RlcEluZGV4LS07XG5cbiAgICAgICAgaWYgKHRoaXMuY3VycmVudFN0ZXBJbmRleCA8IDAgfHwgdGhpcy5jdXJyZW50U3RlcEluZGV4ID49IHRoaXMuc3RlcHMubGVuZ3RoKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEpveXJpZGVTdGVwT3V0T2ZSYW5nZSgnVGhlIGZpcnN0IG9yIGxhc3Qgc3RlcCBvZiB0aGUgdG91ciBjYW5ub3QgYmUgZm91bmQhJyk7XG5cbiAgICAgICAgY29uc3Qgc3RlcE5hbWUgPSB0aGlzLmdldFN0ZXBOYW1lKHRoaXMuc3RlcHNbdGhpcy5jdXJyZW50U3RlcEluZGV4XS5pZCk7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy50ZW1wU3RlcHMuZmluZEluZGV4KHN0ZXAgPT4gc3RlcC5uYW1lID09PSBzdGVwTmFtZSk7XG4gICAgICAgIGxldCBzdGVwRm91bmQgPSB0aGlzLnRlbXBTdGVwc1tpbmRleF07XG4gICAgICAgIHRoaXMuc3RlcHNbdGhpcy5jdXJyZW50U3RlcEluZGV4XS5zdGVwID0gc3RlcEZvdW5kO1xuXG4gICAgICAgIGlmIChzdGVwRm91bmQgPT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIud2FybihgU3RlcCAke3RoaXMuc3RlcHNbdGhpcy5jdXJyZW50U3RlcEluZGV4XS5pZH0gbm90IGZvdW5kIGluIHRoZSBET00uIENoZWNrIGlmIGl0J3MgaGlkZGVuIGJ5ICpuZ0lmIGRpcmVjdGl2ZS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzdGVwRm91bmQ7XG4gICAgfVxuXG4gICAgZ2V0U3RlcFJvdXRlKGFjdGlvbjogU3RlcEFjdGlvblR5cGUpIHtcbiAgICAgICAgbGV0IHN0ZXBJRDogc3RyaW5nO1xuICAgICAgICBpZiAoYWN0aW9uID09PSBTdGVwQWN0aW9uVHlwZS5ORVhUKSB7XG4gICAgICAgICAgICBzdGVwSUQgPSB0aGlzLnN0ZXBzW3RoaXMuY3VycmVudFN0ZXBJbmRleCArIDFdID8gdGhpcy5zdGVwc1t0aGlzLmN1cnJlbnRTdGVwSW5kZXggKyAxXS5pZCA6IG51bGw7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdGVwSUQgPSB0aGlzLnN0ZXBzW3RoaXMuY3VycmVudFN0ZXBJbmRleCAtIDFdID8gdGhpcy5zdGVwc1t0aGlzLmN1cnJlbnRTdGVwSW5kZXggLSAxXS5pZCA6IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHN0ZXBSb3V0ZSA9IHN0ZXBJRCAmJiBzdGVwSUQuaW5jbHVkZXMoUk9VVEVfU0VQQVJBVE9SKSA/IHN0ZXBJRC5zcGxpdChST1VURV9TRVBBUkFUT1IpWzFdIDogJyc7XG5cbiAgICAgICAgcmV0dXJuIHN0ZXBSb3V0ZTtcbiAgICB9XG5cbiAgICB1cGRhdGVQb3NpdGlvbihzdGVwTmFtZTogc3RyaW5nLCBwb3NpdGlvbjogc3RyaW5nKSB7XG4gICAgICAgIGxldCBpbmRleCA9IHRoaXMuZ2V0U3RlcEluZGV4KHN0ZXBOYW1lKTtcbiAgICAgICAgaWYgKHRoaXMuc3RlcHNbaW5kZXhdLnN0ZXApIHtcbiAgICAgICAgICAgIHRoaXMuc3RlcHNbaW5kZXhdLnN0ZXAucG9zaXRpb24gPSBwb3NpdGlvbjtcbiAgICAgICAgICAgIHRoaXMuc3RlcEhhc0JlZW5Nb2RpZmllZC5uZXh0KHRoaXMuc3RlcHNbaW5kZXhdLnN0ZXApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIud2FybihcbiAgICAgICAgICAgICAgICBgVHJ5aW5nIHRvIG1vZGlmeSB0aGUgcG9zaXRpb24gb2YgJHtzdGVwTmFtZX0gdG8gJHtwb3NpdGlvbn0uIFN0ZXAgbm90IGZvdW5kIUlzIHRoaXMgc3RlcCBsb2NhdGVkIGluIGEgZGlmZmVyZW50IHJvdXRlP2BcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZ2V0U3RlcE51bWJlcihzdGVwTmFtZTogc3RyaW5nKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U3RlcEluZGV4KHN0ZXBOYW1lKSArIDE7XG4gICAgfVxuXG4gICAgZ2V0U3RlcHNDb3VudCgpIHtcbiAgICAgICAgbGV0IHN0ZXBzT3JkZXIgPSB0aGlzLnN0ZXBPcHRpb25zLmdldFN0ZXBzT3JkZXIoKTtcbiAgICAgICAgcmV0dXJuIHN0ZXBzT3JkZXIubGVuZ3RoO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0U3RlcEluZGV4KHN0ZXBOYW1lOiBzdHJpbmcpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuc3RlcHNcbiAgICAgICAgICAgIC5tYXAoc3RlcCA9PiAoc3RlcC5pZC5pbmNsdWRlcyhST1VURV9TRVBBUkFUT1IpID8gc3RlcC5pZC5zcGxpdChST1VURV9TRVBBUkFUT1IpWzBdIDogc3RlcC5pZCkpXG4gICAgICAgICAgICAuZmluZEluZGV4KG5hbWUgPT4gc3RlcE5hbWUgPT09IG5hbWUpO1xuICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB0aHJvdyBuZXcgSm95cmlkZUVycm9yKGBUaGUgc3RlcCB3aXRoIG5hbWU6ICR7c3RlcE5hbWV9IGRvZXMgbm90IGV4aXN0IGluIHRoZSBzdGVwIGxpc3QuYCk7XG4gICAgICAgIHJldHVybiBpbmRleDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFN0ZXBOYW1lKHN0ZXBJRDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IHN0ZXBOYW1lID0gc3RlcElEICYmIHN0ZXBJRC5pbmNsdWRlcyhST1VURV9TRVBBUkFUT1IpID8gc3RlcElELnNwbGl0KFJPVVRFX1NFUEFSQVRPUilbMF0gOiBzdGVwSUQ7XG4gICAgICAgIHJldHVybiBzdGVwTmFtZTtcbiAgICB9XG59XG4iXX0=